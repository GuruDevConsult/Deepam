CREATE TABLE [dbo].[AddressFreightInfo](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[AddressID] [int] NULL,
	[Packings] [varchar](50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
	[Weight] [decimal](18, 2) NULL,
	[Fixed] [decimal](18, 2) NULL,
	[BranchName] [varchar](50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
	[Active] [bit] NULL,
	[CreatedBy] [varchar](50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
	[CreatedDate] [datetime] NULL,
	[UpdatedBy] [varchar](50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
	[UpdatedDate] [datetime] NULL,
 CONSTRAINT [PK_AddressFreightInfo] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF

==============================================================================================================================================

create PROC Payments_Check_CollectBy
@EmpName VARCHAR(50)
,@BranchName VARCHAR(50)

AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

SET @SQLString=N'BEGIN SELECT
		EmpName
	FROM
		'+@DBName+'.dbo.Employee
	WHERE
		EmpName='''+@EmpName+'''
	AND
		Active=''True''
	AND
		BranchName='''+@BranchName+'''
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString


========================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go












/*===========================================================
		CREATED BY : Murugan
		CREATED DATE : 07-07-2012
		DESCRIPTION : To  Select Details From DeliverySlip Table 
		UPDATEDDATE:
    ============================================================*/
ALTER PROC [dbo].[Payments_Insert]
(
@ContactID     int
,@CustomerName Varchar(35)
,@CollectedBy Varchar(50)
,@Type varchar(20)
,@PaidDate datetime
,@BalanceAmount decimal(18,2)
,@PaidAmount decimal(18,2)
,@Amount decimal(18,2)
,@PaymentMode varchar(20)
,@MRNO Varchar(20)
,@UserID varchar(20)
,@ID int
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @PaymentID INT
DECLARE @TimeDate as datetime
DECLARE @Time datetime

	SET @Time=(SELECT
	CONVERT(VARCHAR(8),GETDATE(),108) AS ForTime)      
	SET @TimeDate=@PaidDate+@Time

	DECLARE @EmpID INT
	DECLARE @EntryITCount INT
	DECLARE @AccID INT
	DECLARE @AccCashID INT
	DECLARE @AccParcelID INT

	SET @SQLString=N'(SELECT @EmpID=ID FROM '+@DBName+'.dbo.Employee WHERE [EmpName]='''+@CollectedBy+''' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@EmpID INTEGER OUTPUT', @EmpID OUTPUT

	SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount WHERE BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT

	SET @SQLString=N'(SELECT @AccID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+''' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT

	SET @SQLString=N'(SELECT @AccCashID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Cash'' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@AccCashID INTEGER OUTPUT', @AccCashID OUTPUT

	SET @SQLString=N'(SELECT @AccParcelID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Parcel Service'' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@AccParcelID INTEGER OUTPUT', @AccParcelID OUTPUT

BEGIN
IF(@Branchname='Chennai')

IF NOT EXISTS(SELECT * FROM Payments WHERE MRNO=@MRNO AND PaidDate = CONVERT(VARCHAR(10),@PaidDate,108))
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
				IF(@PaidAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@PaidAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
				ELSE IF(@BalanceAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@BalanceAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
		END

	IF(@PaidAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@ContactID
			,@EmpID
			,@TimeDate
			,@PaidAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@ContactID
			,@EmpID
			,@TimeDate
			,@BalanceAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
		
		UPDATE 
		Chennai_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	IF(@PaidAmount!=0)
		BEGIN
			INSERT INTO Chennai_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
			INSERT INTO Chennai_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@BalanceAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
END
ELSE IF(@Branchname='Delhi')
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
		
				UPDATE
					DeliverySlip
				SET
					Balance=Balance-@PaidAmount
				WHERE
					Active='True'
				AND
					ID=@ID
				AND
					BranchName=@BranchName
		END

	INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,@BranchName
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Delhi_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1

INSERT INTO Delhi_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
END
ELSE IF(@Branchname='Coimbatore')
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
		
				UPDATE
					DeliverySlip
				SET
					Balance=Balance-@PaidAmount
				WHERE
					Active='True'
				AND
					ID=@ID
				AND
					BranchName=@BranchName
		END

	INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,@BranchName
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Coimbatore_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	


INSERT INTO Coimbatore_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
END
ELSE IF(@Branchname='Erode')
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
		
				UPDATE
					DeliverySlip
				SET
					Balance=Balance-@PaidAmount
				WHERE
					Active='True'
				AND
					ID=@ID
				AND
					BranchName=@BranchName
		END

	INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,@BranchName
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Erode_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	

INSERT INTO Erode_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
END
ELSE IF(@Branchname='Salem')
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
		
				UPDATE
					DeliverySlip
				SET
					Balance=Balance-@PaidAmount
				WHERE
					Active='True'
				AND
					ID=@ID
				AND
					BranchName=@BranchName
		END

	INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,@BranchName
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Salem_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	

INSERT INTO Salem_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
END
ELSE IF(@Branchname='Tirupur')
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
		
				UPDATE
					DeliverySlip
				SET
					Balance=Balance-@PaidAmount
				WHERE
					Active='True'
				AND
					ID=@ID
				AND
					BranchName=@BranchName
		END

	INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,@BranchName
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Tirupur_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	

INSERT INTO Tirupur_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
END
END
	
--BEGIN
--
--		SET @SQLString=N'IF('''+CONVERT(VARCHAR(10),@MRNO)+'''=''OldBalance'')
--		BEGIN
--			UPDATE
--					' + @DBName + '.dbo.DailyBalance
--				SET
--					TotBalance=TotBalance-'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--				WHERE
--					DeliveryID IS NULL
--				AND
--					ID='''+CONVERT(VARCHAR(10),@ID)+'''
--				AND
--					BranchName='''+@BranchName+'''
--				AND
--					Active=''True''	
--		END
--	ELSE
--		BEGIN
--		
--				UPDATE
--					' + @DBName + '.dbo.DeliverySlip
--				SET
--					Balance=Balance-'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--				WHERE
--					Active=''True''
--				AND
--					ID='''+CONVERT(VARCHAR(10),@ID)+'''
--				AND
--					BranchName='''+@BranchName+'''
--		END
--
--	INSERT INTO
--		' + @DBName + '.dbo.Payments 
--		(
--			PaymentType
--			,MRNO
--			,ContactId
--			,PaidDate
--			,Amount
--			,PaidAmount
--			,PaymentMode
--			,BranchName
--			,Active
--			,CreatedBy
--			,CreatedDate
--		)
--		VALUES
--		(
--			'''+@Type+'''
--			,'''+CONVERT(VARCHAR(10),@MRNO)+'''
--			,'''+CONVERT(VARCHAR(10),@ContactID)+'''
--			,'''+Convert(varchar(10),@PaidDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
--			,'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--			,'''+CONVERT(VARCHAR(10),@Amount)+'''
--			,'''+@PaymentMode+'''
--			,'''+@BranchName+'''
--			,''True''
--			,'''+@UserID+'''
--			,'''+@GetDate+'''
--		)
--		SELECT @PaymentID=SCOPe_IDENTITY()'
--		
--		EXEC sp_executesql @SQLString,N'@PaymentID INTEGER OUTPUT', @PaymentID OUTPUT
--		
--
--	DECLARE @EntryITCount INT
--	DECLARE @AccID INT
--	DECLARE @AccCashID INT
--	DECLARE @AccParcelID INT
--
--	SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount WHERE BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT
--
--	SET @SQLString=N'(SELECT @AccID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+''' AND BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT
--
--	SET @SQLString=N'(SELECT @AccCashID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Cash'' AND BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@AccCashID INTEGER OUTPUT', @AccCashID OUTPUT
--
--	SET @SQLString=N'(SELECT @AccParcelID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Parcel Service'' AND BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@AccParcelID INTEGER OUTPUT', @AccParcelID OUTPUT
--
--	SET @SQLString=N'UPDATE 
--		' + @DBName + '_Acc.dbo.Company_EntryItemCount
--	SET
--		ItemCount=ItemCount+1
--	WHERE
--		BranchName='''+@BranchName+'''
--
--INSERT INTO ' + @DBName + '_Acc.dbo.DebitsCredits
--			(
--				Date
--				,AccountID
--				,PaymentID
--				,Amount
--				,BranchName
--				,CreatedAt
--				,CreatedBy
--				,Type
--				,Status
--				,Particular
--				,RelationAccount
--			)
--		VALUES
--			(
--				'''+Convert(varchar(10),@PaidDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
--				,'''+CONVERT(VARCHAR(10),@AccID)+'''
--				,'''+CONVERT(VARCHAR(10),@PaymentID)+'''
--				,'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--				,'''+@BranchName+'''
--				,'''+@GETDATE+'''
--				,'''+@UserID+'''
--				,''Cr''
--				,1
--				,''Payment Received for MRNo'' + '' '' + ''' + @MRNO + '''
--				,'''+@CustomerName+'''
--			)'
--
--EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString
--
--END



===========================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go











/*--------------------------------------
<CreatedBy   :Murugan P>
<Date	   :10-07-2012	
<Desc:To View Data FROM Payments  and DeliverySlip tables
----------------------------------------*/
ALTER PROC [dbo].[Payments_View]
(
@PaidDate Datetime,
@ContactID Int,
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN

SET @SQLString=N'

; with  report as
(
SELECT
	P. ID
	,D.ID As DeliveryID
	,P.EmpID
	,P.EmpName
	,DaliyBalanceID=CASE WHEN D.ID IS NULL THEN (SELECT ID FROM ' + @DBName + '.dbo.DailyBalance 
		WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+'''
		AND DeliveryID IS NULL AND Active=''True'') ELSE D.ID END
	,PaymentType
	,MRNO= CASE WHEN D.MRNO IS NULL THEN ''0'' ELSE D.MRNO END
	,ContactID=CASE WHEN D.ContactId IS NULL THEN '''+CONVERT(VARCHAR(10),@ContactID)+''' ELSE '''+CONVERT(VARCHAR(10),@ContactID)+''' END
	,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
	,PaidAmount AS PAmt
--	,P.Amount AS PaidAmount
	,PaymentMode
	,Amount=CASE WHEN D.Amount IS NULL THEN (SELECT Balance FROM '+@DBName+'.dbo.DailyBalance 
	WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+''' AND DeliveryID IS NULL 
	AND Active=''True'') ELSE D.Amount END
	,Balance=CASE WHEN D.Balance IS NULL THEN (SELECT TotBalance FROM '+@DBName+'.dbo.DailyBalance 
	WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+''' AND DeliveryID IS NULL 
	AND Active=''True'') ELSE D.Balance END
	,PaidAmount=CASE WHEN (Amount=Balance) THEN NULL ELSE PAmt END
	,CONVERT(VARCHAR(10),DeliveryDate,103) as DeliveryDate
 FROM
	(
	SELECT
		P.ID
		,PaymentType
		,MRNO
		,ContactId
		,E.EmpName
		,ISNULL(EmpID,0) as EmpID
		,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
		,PaidAmount
		,Amount as PAmt
		,PaymentMode

	FROM
		'+@DBName+'.dbo.Payments P
	LEFT JOIN
		'+@DBName+'.dbo.Employee E
	ON
		P.EmpID=E.ID
	WHERE
		P.Active=''True''

	AND
		P.PaidDate='''+CONVERT(VARCHAR(10),@PaidDate,101)+'''+ '' '' + '''+CONVERT(VARCHAR(10),@PaidDate,108)+'''
	AND
		P.BranchName='''+@BranchName+'''

	)P
LEFT JOIN
	(
	SELECT
		F.ID
		,MRNO
		,Amount
		,Balance
		,A.ID as ContactId
		,DeliveryDate

	FROM
		'+@DBName+'.dbo.DeliverySlip F
	JOIN
		'+@DBName+'.dbo.AddressBook A
	ON
		A.Name=F.CustomerName
	WHERE
		A.Active=''True''
	AND
		A.ID='''+CONVERT(VARCHAR(10),@contactid)+'''
	AND
		F.BranchName='''+@BranchName+'''
	)D
	ON
		D.MRNO=P.MRNO
)

SELECT  ID
	,DeliveryID
	,DaliyBalanceID
	,PaymentType
	,DeliveryDate
	,EmpID
	,EmpName
	,MRNO= CASE WHEN MRNO =0 THEN ''OLDBALANCE'' ELSE MRNO END
	,ContactId
	,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
	,PAmt
	,PaidAmount
	,PaymentMode
	,Amount
	,Balance FROM report ORDER BY DeliveryID'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

DECLARE @DBal Decimal(18,2)
DECLARE @PAmt Decimal(18,2)
DECLARE @CustomerName Varchar(25)

SET @SQLString=N'(SELECT @CustomerName=Name FROM '+@DBName+'.dbo.AddressBook WHERE ID='+CONVERT(VARCHAR(10),@contactID)+' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@CustomerName VARCHAR(20) OUTPUT', @CustomerName OUTPUT

SET @SQLString=N'(SELECT @DBal=ISNULL(SUM(Balance),0) FROM '+@DBName+'.dbo.DailyBalance WHERE ContactID='+CONVERT(VARCHAR(10),@contactID)+' 
				AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@DBal INTEGER OUTPUT', @DBal OUTPUT

SET @SQLString=N'(SELECT @PAmt=ISNULL(SUM(Amount),0) FROM '+@DBName+'.dbo.Payments WHERE ContactID='+CONVERT(VARCHAR(10),@contactID)+' 
				AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@PAmt INTEGER OUTPUT', @PAmt OUTPUT

SELECT 
	TotalBalance=@DBal-@PAmt,@CustomerName as PartyName


SET @SQLString=N'SELECT
	ChequeNo
	,CONVERT(VARCHAR(15),ChequeDate,103) as ChequeDate
	,BankName
FROM
	' + @DBName + ' .dbo.Payments_chequeDetails PC
JOIN
	' + @DBName + ' .dbo.Payments P
ON
	P.ID=PC.PaymentsID

WHERE
		PaidDate='''+CONVERT(VARCHAR(10),@PaidDate,101)+'''+ '' '' + '''+CONVERT(VARCHAR(10),@PaidDate,108)+'''
AND
	ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


=========================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go




/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 25-07-2012
		DESCRIPTION : To Check the Balance from the Payments and DeliverySlip
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROC [dbo].[Payments_CheckBal]
(
	@MRNo VARCHAR(30)
	,@PDate DATETIME
	,@ContactID INT
	,@BranchName VARCHAR(50)
)

AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString=N'SELECT
		SUM(Amount) AS CheckAmt
	FROM
		' + @DBName + '.dbo.Payments
	WHERE
		MRNO='''+@MRNO+'''
	AND
		PaidDate!='''+CONVERT(VARCHAR(10),@PDate,101)+'''
	AND
		BranchName='''+@BranchName+'''
	AND
		Active=''True''
	AND
		ContactID='''+CONVERT(VARCHAR(10),@ContactId)+''''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go












/*--------------------------------------
<CreatedBy   :Murugan P>
<Date	   :10-07-2012	
<Desc:To View Data FROM Payments  and DeliverySlip tables
----------------------------------------*/
ALTER PROC [dbo].[Payments_View]
(
@PaidDate Datetime,
@ContactID Int,
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN

SET @SQLString=N'

; with  report as
(
SELECT
	P. ID
--	,D.ID As DeliveryID
	,P.EmpID
	,P.EmpName
	,DeliveryID=CASE WHEN D.ID IS NULL THEN (SELECT ID FROM ' + @DBName + '.dbo.DailyBalance 
		WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+'''
		AND DeliveryID IS NULL AND Active=''True'') ELSE D.ID END
	,PaymentType
	,MRNO= CASE WHEN D.MRNO IS NULL THEN ''0'' ELSE D.MRNO END
	,ContactID=CASE WHEN D.ContactId IS NULL THEN '''+CONVERT(VARCHAR(10),@ContactID)+''' ELSE '''+CONVERT(VARCHAR(10),@ContactID)+''' END
	,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
	,PaidAmount AS PAmt
--	,P.Amount AS PaidAmount
	,PaymentMode
	,Amount=CASE WHEN D.Amount IS NULL THEN (SELECT Balance FROM '+@DBName+'.dbo.DailyBalance 
	WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+''' AND DeliveryID IS NULL 
	AND Active=''True'') ELSE D.Amount END
	,Balance=CASE WHEN D.Balance IS NULL THEN (SELECT TotBalance FROM '+@DBName+'.dbo.DailyBalance 
	WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+''' AND DeliveryID IS NULL 
	AND Active=''True'') ELSE D.Balance END
	,PaidAmount=CASE WHEN (Amount=Balance) THEN NULL ELSE PAmt END
	,CONVERT(VARCHAR(10),DeliveryDate,103) as DeliveryDate
 FROM
	(
	SELECT
		P.ID
		,PaymentType
		,MRNO
		,ContactId
		,E.EmpName
		,ISNULL(EmpID,0) as EmpID
		,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
		,PaidAmount
		,Amount as PAmt
		,PaymentMode

	FROM
		'+@DBName+'.dbo.Payments P
	LEFT JOIN
		'+@DBName+'.dbo.Employee E
	ON
		P.EmpID=E.ID
	WHERE
		P.Active=''True''

	AND
		P.PaidDate='''+CONVERT(VARCHAR(10),@PaidDate,101)+'''+ '' '' + '''+CONVERT(VARCHAR(10),@PaidDate,108)+'''
	AND
		P.BranchName='''+@BranchName+'''

	)P
LEFT JOIN
	(
	SELECT
		F.ID
		,MRNO
		,Amount
		,Balance
		,A.ID as ContactId
		,DeliveryDate

	FROM
		'+@DBName+'.dbo.DeliverySlip F
	JOIN
		'+@DBName+'.dbo.AddressBook A
	ON
		A.Name=F.CustomerName
	WHERE
		A.Active=''True''
	AND
		A.ID='''+CONVERT(VARCHAR(10),@contactid)+'''
	AND
		F.BranchName='''+@BranchName+'''
	)D
	ON
		D.MRNO=P.MRNO
)

SELECT  ID
	,DeliveryID
--	,DaliyBalanceID
	,PaymentType
	,DeliveryDate
	,EmpID
	,EmpName
	,MRNO= CASE WHEN MRNO =0 THEN ''OLDBALANCE'' ELSE MRNO END
	,ContactId
	,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
	,PAmt
	,PaidAmount
	,PaymentMode
	,Amount
	,Balance  FROM report where Paidamount>0  ORDER BY DeliveryID'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

DECLARE @DBal Decimal(18,2)
DECLARE @PAmt Decimal(18,2)
DECLARE @CustomerName Varchar(25)

SET @SQLString=N'(SELECT @CustomerName=Name FROM '+@DBName+'.dbo.AddressBook WHERE ID='+CONVERT(VARCHAR(10),@contactID)+' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@CustomerName VARCHAR(20) OUTPUT', @CustomerName OUTPUT

SET @SQLString=N'(SELECT @DBal=ISNULL(SUM(Balance),0) FROM '+@DBName+'.dbo.DailyBalance WHERE ContactID='+CONVERT(VARCHAR(10),@contactID)+' 
				AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@DBal INTEGER OUTPUT', @DBal OUTPUT

SET @SQLString=N'(SELECT @PAmt=ISNULL(SUM(Amount),0) FROM '+@DBName+'.dbo.Payments WHERE ContactID='+CONVERT(VARCHAR(10),@contactID)+' 
				AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@PAmt INTEGER OUTPUT', @PAmt OUTPUT

SELECT 
	TotalBalance=@DBal-@PAmt,@CustomerName as PartyName


SET @SQLString=N'SELECT
	ChequeNo
	,CONVERT(VARCHAR(15),ChequeDate,103) as ChequeDate
	,BankName
FROM
	' + @DBName + ' .dbo.Payments_chequeDetails PC
JOIN
	' + @DBName + ' .dbo.Payments P
ON
	P.ID=PC.PaymentsID

WHERE
		PaidDate='''+CONVERT(VARCHAR(10),@PaidDate,101)+'''+ '' '' + '''+CONVERT(VARCHAR(10),@PaidDate,108)+'''
AND
	ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


===================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go





/*--------------------------------------
<CreatedBy   :Murugan P>
<Date	   :10-07-2012	
<Desc:To Update Payments 
----------------------------------------*/
ALTER PROC [dbo].[Payments_Update]
(
@ID Int
,@Type Varchar(20)
,@MRNO Varchar(25)
,@Date Datetime
,@PaidAmount Decimal(18,2)
,@Amount Decimal(18,2)
,@PaymentMode Varchar(15)
,@UserID Varchar(20)
,@Balance Decimal(18,2)
,@ContactID Int
,@EmpID Int
,@DeliveryID Int
,@CustomerName Varchar(25)
,@BranchName Varchar(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
DECLARE @PaymentID INT
DECLARE @TimeDate as datetime
DECLARE @Time datetime
DECLARE @EntryITCount INT
DECLARE @AccID INT
DECLARE @AccCashID INT
DECLARE @AccParcelID INT
DECLARE @Pamt DECIMAL(18,2)
DECLARE @TotBal DECIMAL(18,2)
DECLARE @DeliveryBal DECIMAL(18,2)

SET @Time=(SELECT
CONVERT(VARCHAR(8),GETDATE(),108) AS ForTime)      
SET @TimeDate=@Date+@Time

SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount WHERE BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT

SET @SQLString=N'(SELECT @AccID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+''' AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT

SET @SQLString=N'(SELECT @AccCashID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Cash'' AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@AccCashID INTEGER OUTPUT', @AccCashID OUTPUT

SET @SQLString=N'(SELECT @AccParcelID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Parcel Service'' AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@AccParcelID INTEGER OUTPUT', @AccParcelID OUTPUT

SET @SQLString=N'(SELECT @Pamt=SUM(Amount) FROM ' + @DBName + '.dbo.Payments WHERE MRNO='''+CONVERT(VARCHAR(20),@MRNO)+'''
					 AND ID='''+CONVERT(VARCHAR(10),@ID)+''' AND ContactId='''+CONVERT(VARCHAR(10),@ContactID)+'''
					 AND BranchName='''+@BranchName+''' AND  Active=''True'')'
	
EXEC sp_executesql @SQLString,N'@Pamt INTEGER OUTPUT', @Pamt OUTPUT

SET @SQLString=N'(SELECT @TotBal=TotBalance FROM '+@DBName+'.dbo.DailyBalance WHERE DeliveryID IS NULL AND Active=''True''
					AND ContactId='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotBal INTEGER OUTPUT', @TotBal OUTPUT

SET @SQLString=N'(SELECT @DeliveryBal=Balance FROM '+@DBName+'.dbo.DeliverySlip WHERE MRNO='''+CONVERT(VARCHAR(10),@MRNO)+''' AND Active=''True''
					AND ID='''+CONVERT(VARCHAR(10),@DeliveryID)+''' AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@DeliveryBal INTEGER OUTPUT', @DeliveryBal OUTPUT

DECLARE @Bal DECIMAL(18,2)
DECLARE @DBal DECIMAL(18,2)

--SET @DBal=@DeliveryBal-@PaidAmount

IF(@PaidAmount > @Pamt)
BEGIN
SET @Bal=@TotBal-(@PaidAmount-@Pamt)
SET @DBal=@DeliveryBal-(@PaidAmount-@Pamt)
END
ELSE
BEGIN
SET @Bal=@TotBal+(@Pamt-@PaidAmount)
SET @DBal=@DeliveryBal+(@Pamt-@PaidAmount)
END

--SET @Pamt=(SELECT ISNULL(SUM(Amount),0) FROM Payments WHERE MRNO=@MRNO AND ID!=@ID AND ContactId=@ContactID AND  Active='True')

if(@BranchName='Chennai')
	IF(@ID!=0)
		BEGIN
			IF(@MRNO='OLDBALANCE')
			BEGIN
					UPDATE
						DailyBalance
					SET
						TotBalance=@Bal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
			END
		ELSE
			BEGIN
					UPDATE
						DeliverySlip
					SET
						Balance=@DBal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
				
			END

			UPDATE
				Payments
			SET
				PaymentType=@Type
				,MRNO=@MRNO
				,ContactId=ContactID
				,EmpID=@EmpID
				,PaidDate=@TimeDate
				,Amount=@PaidAmount
				,PaidAmount=@Amount
				,PaymentMode=@PaymentMode
				,UpdatedBy=@UserID
				,UpdatedDate=Getdate()
			WHERE
				ID=@ID
			AND
				Active='True'

			UPDATE
				Chennai_Acc.dbo.DebitsCredits
			SET
				Date=@TimeDate
				,Accountid=@AccID
--				,DeliveryID=@DeliveryID
				,PaymentID=@ID
				,Amount	=@PaidAmount			
				,ModifyAt=Getdate()
				,ModifyBy=@UserID
				,RelationAccount=@CustomerName
			WHERE
				PaymentID=@ID
			AND
				Status='True'	
		END
	ELSE
		BEGIN

			UPDATE
					DeliverySlip
				SET
					Balance=Amount-(@Pamt+@PaidAmount)
				WHERE
					Active='True'
				AND
					ID=@DeliveryID

	
			INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Chennai_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1

INSERT INTO Chennai_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
			)
		END

ELSE if(@BranchName='Coimbatore')
	IF(@ID!=0)
		BEGIN
			IF(@MRNO='OLDBALANCE')
			BEGIN
					UPDATE
						DailyBalance
					SET
						TotBalance=@Bal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
			END
		ELSE
			BEGIN
					UPDATE
						DeliverySlip
					SET
						Balance=@DBal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
				
			END

			UPDATE
				Payments
			SET
				PaymentType=@Type
				,MRNO=@MRNO
				,ContactId=ContactID
				,EmpID=@EmpID
				,PaidDate=@TimeDate
				,Amount=@PaidAmount
				,PaidAmount=@Amount
				,PaymentMode=@PaymentMode
				,UpdatedBy=@UserID
				,UpdatedDate=Getdate()
			WHERE
				ID=@ID
			AND
				Active='True'

			UPDATE
				Coimbatore_Acc.dbo.DebitsCredits
			SET
				Date=@TimeDate
				,Accountid=@AccID
--				,DeliveryID=@DeliveryID
				,PaymentID=@ID
				,Amount	=@PaidAmount			
				,ModifyAt=Getdate()
				,ModifyBy=@UserID
				,RelationAccount=@CustomerName
			WHERE
				PaymentID=@ID
			AND
				Status='True'	
		END
	ELSE
		BEGIN

			UPDATE
					DeliverySlip
				SET
					Balance=Amount-(@Pamt+@PaidAmount)
				WHERE
					Active='True'
				AND
					ID=@DeliveryID

	
			INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Coimbatore_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1

INSERT INTO Coimbatore_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
			)
		END

ELSE if(@BranchName='Delhi')
	IF(@ID!=0)
		BEGIN
			IF(@MRNO='OLDBALANCE')
			BEGIN
					UPDATE
						DailyBalance
					SET
						TotBalance=@Bal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
			END
		ELSE
			BEGIN
					UPDATE
						DeliverySlip
					SET
						Balance=@DBal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
				
			END

			UPDATE
				Payments
			SET
				PaymentType=@Type
				,MRNO=@MRNO
				,ContactId=ContactID
				,EmpID=@EmpID
				,PaidDate=@TimeDate
				,Amount=@PaidAmount
				,PaidAmount=@Amount
				,PaymentMode=@PaymentMode
				,UpdatedBy=@UserID
				,UpdatedDate=Getdate()
			WHERE
				ID=@ID
			AND
				Active='True'

			UPDATE
				Delhi_Acc.dbo.DebitsCredits
			SET
				Date=@TimeDate
				,Accountid=@AccID
--				,DeliveryID=@DeliveryID
				,PaymentID=@ID
				,Amount	=@PaidAmount			
				,ModifyAt=Getdate()
				,ModifyBy=@UserID
				,RelationAccount=@CustomerName
			WHERE
				PaymentID=@ID
			AND
				Status='True'	
		END
	ELSE
		BEGIN

			UPDATE
					DeliverySlip
				SET
					Balance=Amount-(@Pamt+@PaidAmount)
				WHERE
					Active='True'
				AND
					ID=@DeliveryID

	
			INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Delhi_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1

INSERT INTO Delhi_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
			)
		END

ELSE if(@BranchName='Erode')
	IF(@ID!=0)
		BEGIN
			IF(@MRNO='OLDBALANCE')
			BEGIN
					UPDATE
						DailyBalance
					SET
						TotBalance=@Bal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
			END
		ELSE
			BEGIN
					UPDATE
						DeliverySlip
					SET
						Balance=@DBal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
				
			END

			UPDATE
				Payments
			SET
				PaymentType=@Type
				,MRNO=@MRNO
				,ContactId=ContactID
				,EmpID=@EmpID
				,PaidDate=@TimeDate
				,Amount=@PaidAmount
				,PaidAmount=@Amount
				,PaymentMode=@PaymentMode
				,UpdatedBy=@UserID
				,UpdatedDate=Getdate()
			WHERE
				ID=@ID
			AND
				Active='True'

			UPDATE
				Erode_Acc.dbo.DebitsCredits
			SET
				Date=@TimeDate
				,Accountid=@AccID
--				,DeliveryID=@DeliveryID
				,PaymentID=@ID
				,Amount	=@PaidAmount			
				,ModifyAt=Getdate()
				,ModifyBy=@UserID
				,RelationAccount=@CustomerName
			WHERE
				PaymentID=@ID
			AND
				Status='True'	
		END
	ELSE
		BEGIN

			UPDATE
					DeliverySlip
				SET
					Balance=Amount-(@Pamt+@PaidAmount)
				WHERE
					Active='True'
				AND
					ID=@DeliveryID

	
			INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Erode_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1

INSERT INTO Erode_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
			)
		END

ELSE if(@BranchName='Salem')
	IF(@ID!=0)
		BEGIN
			IF(@MRNO='OLDBALANCE')
			BEGIN
					UPDATE
						DailyBalance
					SET
						TotBalance=@Bal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
			END
		ELSE
			BEGIN
					UPDATE
						DeliverySlip
					SET
						Balance=@DBal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
				
			END

			UPDATE
				Payments
			SET
				PaymentType=@Type
				,MRNO=@MRNO
				,ContactId=ContactID
				,EmpID=@EmpID
				,PaidDate=@TimeDate
				,Amount=@PaidAmount
				,PaidAmount=@Amount
				,PaymentMode=@PaymentMode
				,UpdatedBy=@UserID
				,UpdatedDate=Getdate()
			WHERE
				ID=@ID
			AND
				Active='True'

			UPDATE
				Salem_Acc.dbo.DebitsCredits
			SET
				Date=@TimeDate
				,Accountid=@AccID
--				,DeliveryID=@DeliveryID
				,PaymentID=@ID
				,Amount	=@PaidAmount			
				,ModifyAt=Getdate()
				,ModifyBy=@UserID
				,RelationAccount=@CustomerName
			WHERE
				PaymentID=@ID
			AND
				Status='True'	
		END
	ELSE
		BEGIN

			UPDATE
					DeliverySlip
				SET
					Balance=Amount-(@Pamt+@PaidAmount)
				WHERE
					Active='True'
				AND
					ID=@DeliveryID

	
			INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Salem_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1

INSERT INTO Salem_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
			)
		END

ELSE if(@BranchName='Tirupur')
	IF(@ID!=0)
		BEGIN
			IF(@MRNO='OLDBALANCE')
			BEGIN
					UPDATE
						DailyBalance
					SET
						TotBalance=@Bal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
			END
		ELSE
			BEGIN
					UPDATE
						DeliverySlip
					SET
						Balance=@DBal
					WHERE
						ID=@DeliveryID
					AND
						BranchName=@BranchName
					AND
						Active='True'
				
			END

			UPDATE
				Payments
			SET
				PaymentType=@Type
				,MRNO=@MRNO
				,ContactId=ContactID
				,EmpID=@EmpID
				,PaidDate=@TimeDate
				,Amount=@PaidAmount
				,PaidAmount=@Amount
				,PaymentMode=@PaymentMode
				,UpdatedBy=@UserID
				,UpdatedDate=Getdate()
			WHERE
				ID=@ID
			AND
				Active='True'

			UPDATE
				Tirupur_Acc.dbo.DebitsCredits
			SET
				Date=@TimeDate
				,Accountid=@AccID
--				,DeliveryID=@DeliveryID
				,PaymentID=@ID
				,Amount	=@PaidAmount			
				,ModifyAt=Getdate()
				,ModifyBy=@UserID
				,RelationAccount=@CustomerName
			WHERE
				PaymentID=@ID
			AND
				Status='True'	
		END
	ELSE
		BEGIN

			UPDATE
					DeliverySlip
				SET
					Balance=Amount-(@Pamt+@PaidAmount)
				WHERE
					Active='True'
				AND
					ID=@DeliveryID

	
			INSERT INTO
		 Payments 
		(
			PaymentType
			,MRNO
			,ContactId
			,EmpID
			,PaidDate
			,Amount
			,PaidAmount
			,PaymentMode
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
		@Type
		,@MRNO
		,@ContactID
		,@EmpID
		,@TimeDate
		,@PaidAmount 
		,@Amount
		,@PaymentMode
		,'True'
		,@UserID
		,getdate()
		)
		SET @PaymentID=SCOPe_IDENTITY()
		SELECT @PaymentID
		
		UPDATE 
		Tirupur_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1

INSERT INTO Tirupur_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
			)
		END

	END




=======================================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go
















/*===========================================================
		CREATED BY : Murugan
		CREATED DATE : 21-03-2012
		DESCRIPTION : To  Select Details From DeliverySlip Table 
		UPDATEDDATE:
    ============================================================*/



ALTER PROC [dbo].[Payments_GridSelect]
(
@PartyName Varchar(50),
@BranchName VARCHAR(50)

)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @ContactId int
DECLARE @PaidAmt DECIMAL(18,2)
SET @PaidAmt=0
SET @SQLString=N'(SELECT @ContactId=ID FROM ' + @DBName + '.dbo.AddressBook WHERE Name='''+@PartyName+'''
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@ContactId INTEGER OUTPUT', @ContactId OUTPUT
BEGIN

	SET @SQLString=N'SELECT
		D.ID
		,A.ID as ContactID
		,D.ID as DeliveryID
--		,D.CustomerName
		,CONVERT(VARCHAR(10),D.DeliveryDate,103) as DeliveryDate
		,D.MRNO
		,D.Amount
		,D.Balance
		,'''+CONVERT(VARCHAR(10),@PaidAmt)+''' as PaidAmount
--		,T.TotalBalance
	FROM
		' + @DBName + '.dbo.DeliverySlip D
	JOIN	
		' + @DBName + '.dbo.AddressBook A	
	ON	
		A.[Name]=D.CustomerName
	
	WHERE
		D.CustomerName='''+@PartyName+'''
	AND
		D.BranchName='''+@BranchName+'''
	AND 
		D.Active=''True''
	AND
		Balance!=0
	AND
		A.Active=1

	Order BY MRNO'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END
		BEGIN
			DECLARE @DBal Decimal(18,2)
			DECLARE @PAmt Decimal(18,2)
			DECLARE @Tot Decimal(18,2)

			SET @SQLString=N'(SELECT @Tot=ISNULL(SUM(Balance),0) FROM '+@DBName+'.dbo.DeliverySlip 
								WHERE CustomerName='''+@PartyName+''' AND BranchName='''+@BranchName+''' AND Active=''True'')'
		
			EXEC sp_executesql @SQLString,N'@Tot INTEGER OUTPUT', @Tot OUTPUT
			
			SET @SQLString=N'(SELECT @DBal=ISNULL(SUM(TotBalance),0) FROM ' + @DBName + '.dbo.DailyBalance 
								WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactId)+''' AND DeliveryID IS NULL AND Active=''True'')'
	
			EXEC sp_executesql @SQLString,N'@DBal INTEGER OUTPUT', @DBal OUTPUT

			SELECT 
				TotalBalance=@Tot+@DBal

			
--			SET @PAmt=(SELECT ISNULL(SUM(Amount),0) FROM Payments WHERE ContactID=@ContactId AND Active='True')
--
--			SELECT 
--				TotalBalance=@DBal-@PAmt
		END

		BEGIN
			DECLARE @MRNO Varchar(20)
			SET @MRNO='OldBalance'

			SET @SQLString=N'SELECT 
				DB.ID,C.ID as ContactID ,ISNULL(DeliveryID,0) as DeliveryID,'' ''  as DeliveryDate,'''+@MRNO+''' as MRNO,Balance as Amount
				,TotBalance as Balance ,'''+CONVERT(VARCHAR(10),@PaidAmt)+''' as PaidAmount
			FROM
				' + @DBName + '.dbo.AddressBook C 
			JOIN
				' + @DBName + '.dbo.DailyBalance DB
			ON
				DB.ContactID=C.ID 
			WHERE
				 DeliveryID IS NULL AND DB.ContactID='''+CONVERT(VARCHAR(10),@ContactId)+'''
			AND 
				DB.BranchName='''+@BranchName+''' AND DB.Active=''True'' AND TotBalance!=0'

		EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString
			
		END


=======================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go





ALTER PROCEDURE [dbo].[AutoGenenationID]
(
--	 @CompanyID		INT
	@IDType		VARCHAR(10)
	,@BranchName	VARCHAR(50)
)
AS
BEGIN

DECLARE	@AutoID	INT
DECLARE	@TempID	INT
DECLARE @ID varchar(1000)

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000),@UseAndExecStatment1 int, @SQLString NVARCHAR(4000), @SQLString1 int

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'


SET @SQLString=('SELECT @ID=ID FROM '+@dbname + '.dbo.Autogeneration 
					WHERE BranchName='''+@BranchName+'''')

EXEC sp_executesql @SQLString,N'@ID INTEGER OUTPUT', @ID OUTPUT


SET @SQLString = N'
 	IF ('''+@IDType+''' = ''BDLRNo'')
	BEGIN
		SELECT @AutoID = ISNULL(BookDetails_LRNo,0) FROM ' + @DBName + '.dbo.Autogeneration 
				WHERE ID = ''' + @ID + '''
	END
	ELSE IF ('''+@IDType+''' = ''LSlipNo'')
	BEGIN
		SELECT @AutoID = ISNULL(LorryAcSlip_SlipNo,0) FROM ' + @DBName + '.dbo.Autogeneration WHERE ID = ''' + @ID + '''
	END
	ELSE IF ('''+@IDType+''' = ''DSMRNo'')
	BEGIN
		SELECT @AutoID = ISNULL(DeliverySlip_MRNo,0) FROM ' + @DBName + '.dbo.Autogeneration WHERE ID = ''' + @ID + '''
	END
	ELSE IF ('''+@IDType+''' = ''PNo'')
	BEGIN
		SELECT @AutoID = ISNULL(Payments_RNo,0) FROM ' + @DBName + '.dbo.Autogeneration WHERE ID = ''' + @ID + '''
	END
	ELSE IF ('''+@IDType+''' = ''RBDLRNo'')
	BEGIN
		SELECT @AutoID = ISNULL(ReceivedBookDetails_LRNo,0) FROM ' + @DBName + '.dbo.Autogeneration WHERE ID = ''' + @ID + '''
	END
	ELSE IF ('''+@IDType+''' = ''CHNo'')
	BEGIN
		SELECT @AutoID = ISNULL(LorryChallan_ChallanNo,0) FROM ' + @DBName + '.dbo.Autogeneration WHERE ID = ''' + @ID + '''
	END
	ELSE IF ('''+@IDType+''' = ''DSNo'')
	BEGIN
		SELECT @AutoID = ISNULL(DeliveryStatement_No,0) FROM ' + @DBName + '.dbo.Autogeneration WHERE ID = ''' + @ID + '''
	END
	ELSE IF ('''+@IDType+''' = ''DBNo'')
	BEGIN
		SELECT @AutoID = ISNULL(DayBook_No,0) FROM ' + @DBName + '.dbo.Autogeneration WHERE ID = ''' + @ID + '''
	END'

EXEC sp_executesql @SQLString,N'@AutoID INTEGER OUTPUT', @AutoID OUTPUT

SET @AutoID = @AutoID + 1
	SET @TempID = CONVERT(VARCHAR(20),@AutoID)
	SELECT @TempID 
select (@autoid) as d
select (@tempid) as d1
select (@id) as d2

END


=====================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go

ALTER PROC [dbo].[Payments_Check_CollectBy]
@EmpName VARCHAR(50)
,@BranchName VARCHAR(50)

AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

SET @SQLString=N'BEGIN SELECT
		EmpName
	FROM
		'+@DBName+'.dbo.Employee
	WHERE
		EmpName='''+@EmpName+'''
	AND
		Active=''True''
	AND
		BranchName='''+@BranchName+'''
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

===========================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go













/*===========================================================
		CREATED BY : Murugan
		CREATED DATE : 07-07-2012
		DESCRIPTION : To  Select Details From DeliverySlip Table 
		UPDATEDDATE:
    ============================================================*/
ALTER PROC [dbo].[Payments_Insert]
(
@RNo	INT
,@ContactID  int
,@CustomerName Varchar(35)
,@CollectedBy Varchar(50)
,@Type varchar(20)
,@PaidDate datetime
,@BalanceAmount decimal(18,2)
,@PaidAmount decimal(18,2)
,@Amount decimal(18,2)
,@PaymentMode varchar(20)
,@MRNO Varchar(20)
,@UserID varchar(20)
,@ID int
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @PaymentID INT
DECLARE @TimeDate as datetime
DECLARE @Time datetime

	SET @Time=(SELECT
	CONVERT(VARCHAR(8),GETDATE(),108) AS ForTime)      
	SET @TimeDate=@PaidDate+@Time

	DECLARE @EmpID INT
	DECLARE @EntryITCount INT
	DECLARE @AccID INT
	DECLARE @AccCashID INT
	DECLARE @AccParcelID INT

	SET @SQLString=N'(SELECT @EmpID=ID FROM '+@DBName+'.dbo.Employee WHERE [EmpName]='''+@CollectedBy+''' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@EmpID INTEGER OUTPUT', @EmpID OUTPUT

	SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount WHERE BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT

	SET @SQLString=N'(SELECT @AccID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+''' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT

	SET @SQLString=N'(SELECT @AccCashID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Cash'' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@AccCashID INTEGER OUTPUT', @AccCashID OUTPUT

	SET @SQLString=N'(SELECT @AccParcelID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Parcel Service'' AND BranchName='''+@BranchName+''')'

	EXEC sp_executesql @SQLString,N'@AccParcelID INTEGER OUTPUT', @AccParcelID OUTPUT

BEGIN
IF(@Branchname='Chennai')

IF NOT EXISTS(SELECT * FROM Payments WHERE MRNO=@MRNO AND ReceiptNo = @RNo)
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
				IF(@PaidAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@PaidAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
				ELSE IF(@BalanceAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@BalanceAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
		END

	IF(@PaidAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@PaidAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@BalanceAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
		
		UPDATE 
		Chennai_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	IF(@PaidAmount!=0)
		BEGIN
			INSERT INTO Chennai_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
			INSERT INTO Chennai_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@BalanceAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	UPDATE
				Autogeneration
		SET
				Payments_RNo=@RNo

	 SELECT @RNo


END
ELSE IF(@Branchname='Delhi')
IF NOT EXISTS(SELECT * FROM Payments WHERE MRNO=@MRNO AND ReceiptNo = @RNo)
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
				IF(@PaidAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@PaidAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
				ELSE IF(@BalanceAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@BalanceAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
		END

	IF(@PaidAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@PaidAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@BalanceAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
		
		UPDATE 
		Delhi_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	IF(@PaidAmount!=0)
		BEGIN
			INSERT INTO Delhi_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
			INSERT INTO Delhi_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@BalanceAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	UPDATE
				Autogeneration
		SET
				Payments_RNo=@RNo

	 SELECT @RNo


END
ELSE IF(@Branchname='Coimbatore')
IF NOT EXISTS(SELECT * FROM Payments WHERE MRNO=@MRNO AND ReceiptNo = @RNo)
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
				IF(@PaidAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@PaidAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
				ELSE IF(@BalanceAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@BalanceAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
		END

	IF(@PaidAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@PaidAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@BalanceAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
		
		UPDATE 
		Coimbatore_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	IF(@PaidAmount!=0)
		BEGIN
			INSERT INTO Coimbatore_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
			INSERT INTO Coimbatore_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@BalanceAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	UPDATE
				Autogeneration
		SET
				Payments_RNo=@RNo

	 SELECT @RNo


END
ELSE IF(@Branchname='Erode')
IF NOT EXISTS(SELECT * FROM Payments WHERE MRNO=@MRNO AND ReceiptNo = @RNo)
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
				IF(@PaidAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@PaidAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
				ELSE IF(@BalanceAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@BalanceAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
		END

	IF(@PaidAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@PaidAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@BalanceAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
		
		UPDATE 
		Erode_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	IF(@PaidAmount!=0)
		BEGIN
			INSERT INTO Erode_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
			INSERT INTO Erode_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@BalanceAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	UPDATE
				Autogeneration
		SET
				Payments_RNo=@RNo

	 SELECT @RNo


END
ELSE IF(@Branchname='Salem')
IF NOT EXISTS(SELECT * FROM Payments WHERE MRNO=@MRNO AND ReceiptNo = @RNo)
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
				IF(@PaidAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@PaidAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
				ELSE IF(@BalanceAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@BalanceAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
		END

	IF(@PaidAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@PaidAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@BalanceAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
		
		UPDATE 
		Salem_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	IF(@PaidAmount!=0)
		BEGIN
			INSERT INTO Salem_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
			INSERT INTO Salem_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@BalanceAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	UPDATE
				Autogeneration
		SET
				Payments_RNo=@RNo

	 SELECT @RNo


END
ELSE IF(@Branchname='Tirupur')
IF NOT EXISTS(SELECT * FROM Payments WHERE MRNO=@MRNO AND ReceiptNo = @RNo)
BEGIN
		IF(@MRNO='OldBalance')
		BEGIN
			UPDATE
					DailyBalance
				SET
					TotBalance=TotBalance-@PaidAmount
				WHERE
--					ContactID=@ContactID
--				AND					
					DeliveryID IS NULL
				AND
					ID=@ID
				AND
					BranchName=@BranchName
				AND
					Active='True'	
		END
	ELSE
		BEGIN
				IF(@PaidAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@PaidAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
				ELSE IF(@BalanceAmount!=0)
					BEGIN
						UPDATE
							DeliverySlip
						SET
							Balance=Balance-@BalanceAmount
						WHERE
							Active='True'
						AND
							ID=@ID
						AND
							BranchName=@BranchName
					END
		END

	IF(@PaidAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@PaidAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
		INSERT INTO
			 Payments 
			(
				PaymentType
				,MRNO
				,ReceiptNo
				,ContactId
				,EmpID
				,PaidDate
				,Amount
				,PaidAmount
				,PaymentMode
				,BranchName
				,Active
				,CreatedBy
				,CreatedDate
			)
			VALUES
			(
			@Type
			,@MRNO
			,@RNo
			,@ContactID
			,@EmpID
			,@TimeDate
			,@BalanceAmount 
			,@Amount
			,@PaymentMode
			,@BranchName
			,'True'
			,@UserID
			,getdate()
			)
			SET @PaymentID=SCOPe_IDENTITY()
			SELECT @PaymentID
		END
		
		UPDATE 
		Tirupur_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ItemCount+1
	
	IF(@PaidAmount!=0)
		BEGIN
			INSERT INTO Tirupur_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@PaidAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	ELSE IF(@BalanceAmount!=0)
		BEGIN
			INSERT INTO Tirupur_Acc.dbo.DebitsCredits
			(
				Date
				,AccountID
				,PaymentID
				,Amount
				,BranchName
				,CreatedAt
				,CreatedBy
				,Type
				,Status
				,Particular
				,RelationAccount
				,EntryItemCount
			)
		VALUES
			(
				@TimeDate
				,@AccID
				,@PaymentID
--				,@AccParcelID
				,@BalanceAmount
				,@BranchName
				,GETDATE()
				,@UserID
				,'Cr'
				,1
				,'Payment Received for MRNo' + ' ' + @MRNO
				,@CustomerName
				,@EntryITCount
			)
		END
	UPDATE
				Autogeneration
		SET
				Payments_RNo=@RNo

	 SELECT @RNo


END
END
	
--BEGIN
--
--		SET @SQLString=N'IF('''+CONVERT(VARCHAR(10),@MRNO)+'''=''OldBalance'')
--		BEGIN
--			UPDATE
--					' + @DBName + '.dbo.DailyBalance
--				SET
--					TotBalance=TotBalance-'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--				WHERE
--					DeliveryID IS NULL
--				AND
--					ID='''+CONVERT(VARCHAR(10),@ID)+'''
--				AND
--					BranchName='''+@BranchName+'''
--				AND
--					Active=''True''	
--		END
--	ELSE
--		BEGIN
--		
--				UPDATE
--					' + @DBName + '.dbo.DeliverySlip
--				SET
--					Balance=Balance-'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--				WHERE
--					Active=''True''
--				AND
--					ID='''+CONVERT(VARCHAR(10),@ID)+'''
--				AND
--					BranchName='''+@BranchName+'''
--		END
--
--	INSERT INTO
--		' + @DBName + '.dbo.Payments 
--		(
--			PaymentType
--			,MRNO
--			,ContactId
--			,PaidDate
--			,Amount
--			,PaidAmount
--			,PaymentMode
--			,BranchName
--			,Active
--			,CreatedBy
--			,CreatedDate
--		)
--		VALUES
--		(
--			'''+@Type+'''
--			,'''+CONVERT(VARCHAR(10),@MRNO)+'''
--			,'''+CONVERT(VARCHAR(10),@ContactID)+'''
--			,'''+Convert(varchar(10),@PaidDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
--			,'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--			,'''+CONVERT(VARCHAR(10),@Amount)+'''
--			,'''+@PaymentMode+'''
--			,'''+@BranchName+'''
--			,''True''
--			,'''+@UserID+'''
--			,'''+@GetDate+'''
--		)
--		SELECT @PaymentID=SCOPe_IDENTITY()'
--		
--		EXEC sp_executesql @SQLString,N'@PaymentID INTEGER OUTPUT', @PaymentID OUTPUT
--		
--
--	DECLARE @EntryITCount INT
--	DECLARE @AccID INT
--	DECLARE @AccCashID INT
--	DECLARE @AccParcelID INT
--
--	SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount WHERE BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT
--
--	SET @SQLString=N'(SELECT @AccID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+''' AND BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT
--
--	SET @SQLString=N'(SELECT @AccCashID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Cash'' AND BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@AccCashID INTEGER OUTPUT', @AccCashID OUTPUT
--
--	SET @SQLString=N'(SELECT @AccParcelID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]=''Parcel Service'' AND BranchName='''+@BranchName+''')'
--
--	EXEC sp_executesql @SQLString,N'@AccParcelID INTEGER OUTPUT', @AccParcelID OUTPUT
--
--	SET @SQLString=N'UPDATE 
--		' + @DBName + '_Acc.dbo.Company_EntryItemCount
--	SET
--		ItemCount=ItemCount+1
--	WHERE
--		BranchName='''+@BranchName+'''
--
--INSERT INTO ' + @DBName + '_Acc.dbo.DebitsCredits
--			(
--				Date
--				,AccountID
--				,PaymentID
--				,Amount
--				,BranchName
--				,CreatedAt
--				,CreatedBy
--				,Type
--				,Status
--				,Particular
--				,RelationAccount
--			)
--		VALUES
--			(
--				'''+Convert(varchar(10),@PaidDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
--				,'''+CONVERT(VARCHAR(10),@AccID)+'''
--				,'''+CONVERT(VARCHAR(10),@PaymentID)+'''
--				,'''+CONVERT(VARCHAR(10),@PaidAmount)+'''
--				,'''+@BranchName+'''
--				,'''+@GETDATE+'''
--				,'''+@UserID+'''
--				,''Cr''
--				,1
--				,''Payment Received for MRNo'' + '' '' + ''' + @MRNO + '''
--				,'''+@CustomerName+'''
--			)'
--
--EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString
--
--END


===========================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go













/*--------------------------------------
<CreatedBy   :Murugan P>
<Date	   :10-07-2012	
<Desc:To View Data FROM Payments  and DeliverySlip tables
----------------------------------------*/
ALTER PROC [dbo].[Payments_View]
(
@PaidDate Datetime,
@ContactID Int,
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN

SET @SQLString=N'

; with  report as
(
SELECT
	P. ID
	,ReceiptNo
--	,D.ID As DeliveryID
	,P.EmpID
	,P.EmpName
	,DeliveryID=CASE WHEN D.ID IS NULL THEN (SELECT ID FROM ' + @DBName + '.dbo.DailyBalance 
		WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+'''
		AND DeliveryID IS NULL AND Active=''True'') ELSE D.ID END
	,PaymentType
	,MRNO= CASE WHEN D.MRNO IS NULL THEN ''0'' ELSE D.MRNO END
	,ContactID=CASE WHEN D.ContactId IS NULL THEN '''+CONVERT(VARCHAR(10),@ContactID)+''' ELSE '''+CONVERT(VARCHAR(10),@ContactID)+''' END
	,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
	,PaidAmount AS PAmt
--	,P.Amount AS PaidAmount
	,PaymentMode
	,Amount=CASE WHEN D.Amount IS NULL THEN (SELECT Balance FROM '+@DBName+'.dbo.DailyBalance 
	WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+''' AND DeliveryID IS NULL 
	AND Active=''True'') ELSE D.Amount END
	,Balance=CASE WHEN D.Balance IS NULL THEN (SELECT TotBalance FROM '+@DBName+'.dbo.DailyBalance 
	WHERE ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''' AND BranchName='''+@BranchName+''' AND DeliveryID IS NULL 
	AND Active=''True'') ELSE D.Balance END
	,PaidAmount=CASE WHEN (Amount=Balance) THEN NULL ELSE PAmt END
	,CONVERT(VARCHAR(10),DeliveryDate,103) as DeliveryDate
 FROM
	(
	SELECT
		P.ID
		,PaymentType
		,MRNO
		,ReceiptNo
		,ContactId
		,E.EmpName
		,ISNULL(EmpID,0) as EmpID
		,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
		,PaidAmount
		,Amount as PAmt
		,PaymentMode

	FROM
		'+@DBName+'.dbo.Payments P
	LEFT JOIN
		'+@DBName+'.dbo.Employee E
	ON
		P.EmpID=E.ID
	WHERE
		P.Active=''True''

	AND
		P.PaidDate='''+CONVERT(VARCHAR(10),@PaidDate,101)+'''+ '' '' + '''+CONVERT(VARCHAR(10),@PaidDate,108)+'''
	AND
		P.BranchName='''+@BranchName+'''

	)P
LEFT JOIN
	(
	SELECT
		F.ID
		,MRNO
		,Amount
		,Balance
		,A.ID as ContactId
		,DeliveryDate

	FROM
		'+@DBName+'.dbo.DeliverySlip F
	JOIN
		'+@DBName+'.dbo.AddressBook A
	ON
		A.Name=F.CustomerName
	WHERE
		A.Active=''True''
	AND
		A.ID='''+CONVERT(VARCHAR(10),@contactid)+'''
	AND
		F.BranchName='''+@BranchName+'''
	)D
	ON
		D.MRNO=P.MRNO
)

SELECT  ID
	,DeliveryID
	,ReceiptNo
--	,DaliyBalanceID
	,PaymentType
	,DeliveryDate
	,EmpID
	,EmpName
	,MRNO= CASE WHEN MRNO =0 THEN ''OLDBALANCE'' ELSE MRNO END
	,ContactId
	,CONVERT(VARCHAR(15),PaidDate,103) PaidDate
	,PAmt
	,PaidAmount
	,PaymentMode
	,Amount
	,Balance  FROM report where Paidamount>0  ORDER BY DeliveryID'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

DECLARE @DBal Decimal(18,2)
DECLARE @PAmt Decimal(18,2)
DECLARE @CustomerName Varchar(25)

SET @SQLString=N'(SELECT @CustomerName=Name FROM '+@DBName+'.dbo.AddressBook WHERE ID='+CONVERT(VARCHAR(10),@contactID)+' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@CustomerName VARCHAR(20) OUTPUT', @CustomerName OUTPUT

SET @SQLString=N'(SELECT @DBal=ISNULL(SUM(Balance),0) FROM '+@DBName+'.dbo.DailyBalance WHERE ContactID='+CONVERT(VARCHAR(10),@contactID)+' 
				AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@DBal INTEGER OUTPUT', @DBal OUTPUT

SET @SQLString=N'(SELECT @PAmt=ISNULL(SUM(Amount),0) FROM '+@DBName+'.dbo.Payments WHERE ContactID='+CONVERT(VARCHAR(10),@contactID)+' 
				AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@PAmt INTEGER OUTPUT', @PAmt OUTPUT

SELECT 
	TotalBalance=@DBal-@PAmt,@CustomerName as PartyName


SET @SQLString=N'SELECT
	ChequeNo
	,CONVERT(VARCHAR(15),ChequeDate,103) as ChequeDate
	,BankName
FROM
	' + @DBName + ' .dbo.Payments_chequeDetails PC
JOIN
	' + @DBName + ' .dbo.Payments P
ON
	P.ID=PC.PaymentsID

WHERE
		PaidDate='''+CONVERT(VARCHAR(10),@PaidDate,101)+'''+ '' '' + '''+CONVERT(VARCHAR(10),@PaidDate,108)+'''
AND
	ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


==================================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go








/*------------------------------------------
<Author : Murugan >
<Date   :19-01-2012>
-------------------------------------------*/

ALTER PROC [dbo].[Payments_View_PartyName]
(
@FromDate Datetime,
@Todate   Datetime,
@BranchName VARCHAR(50)
)
As

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString=N'SELECT
		Distinct Name as PartyName,
		 ContactId 
		
	FROM
		 ' + @DBName + '.dbo.Payments P 
	join 
		 ' + @DBName + '.dbo.AddressBook AB
	on
		P.ContactId=AB.ID
	WHERE
		P.PaidDate BETWEEN '''+CONVERT(VARCHAR(10),@FromDate,101)+''' AND '''+CONVERT(VARCHAR(10),@ToDate,101)+'''
	AND
		P.BranchName='''+@BranchName+''''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

=========================================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go









	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To Add Or Insert New record to the AddressBook and AddressInfo Table and Deepak_Acc.dbo.Accounts
		NOTE:  Inserting in TWO DATABASE(DeepakRoadways and Deepak_Acc)
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_I]
(
			@AgentCode VARCHAR(50)		 
			,@Address VARCHAR(50)		   
			,@Category VARCHAR(50)		   
			,@PinCode INT
			,@City VARCHAR(20)
			,@Name VARCHAR(50)   
			,@SurName VARCHAR(20) 
			,@OriCustName VARCHAR(25) 
			,@GroupName VARCHAR(25)
			,@GroupID  INT       
			,@PhonePrime varchar(20)
			,@PhoneSecondary varchar(20)
			,@Mob1 VARCHAR(15)
			,@Mob2 VARCHAR(15)
			,@EmailPrime varchar(40)
			,@EmailSecondary varchar(40)
			,@Website varchar(50)
			,@Fax varchar(30)
			,@TINNo varchar(30)
			,@CSTNo varchar(20)
			,@Areacode varchar(20) 
			,@Freight DECIMAL(18,2)
			,@Labour DECIMAL(18,2)
			,@Delivery DECIMAL(18,2)
			,@Stationary DECIMAL(18,2)
			,@Demurrage DECIMAL(18,2)
			,@LocalCartage DECIMAL(18,2)
			,@ServiceTax DECIMAL(18,2)
			,@UserID varchar(25)
			,@BranchName varchar(50)
)
AS


BEGIN

DECLARE @AddressInfoID INT
DECLARE @ChargesInfoID INT
DECLARE @AddressBookInfoID INT

SET @PinCode=CONVERT(VARCHAR(15),@PinCode)

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

SET @SQLString = N'IF NOT EXISTS(SELECT Name FROM ' + @DBName + '.dbo.AddressBook WHERE Name='''+@Name+'''   AND BranchName=  '''+@BranchName+''' AND
									Active=''True'')
BEGIN
IF('+CONVERT(VARCHAR(15),@PinCode)+' != 0)
	BEGIN
		INSERT INTO ' +@DBName+'.dbo.AddressInfo
		(
					Address 
				    ,PinCode 
				    ,City 
					,BranchName
				    ,CreatedBy
				    ,CreatedDate
				    ,Active
		)
		VALUES
		(
					'''+@Address+'''
					,'''+CONVERT(VARCHAR(15),@PinCode)+'''
					,'''+@City+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END
	ELSE
	BEGIN
		INSERT INTO ' +@DBName+'.dbo.AddressInfo
		(
					Address 
					,City 
					,BranchName
					,CreatedBy
					,CreatedDate
					,Active
		)
		VALUES
		(
					'''+@Address+'''
					,'''+@City+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END
END
SELECT @AddressInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@AddressInfoID INTEGER OUTPUT', @AddressInfoID OUTPUT

SET @SQLString=N'BEGIN
		INSERT INTO ' +@DBName+'.dbo.AddressChargesInfo
		(
					Freight 
					,Labour 
					,Delivery
					,Stationary
					,Demurrage
					,LocalCartage
					,ServiceTax
					,BranchName
					,CreatedBy
					,CreatedDate
					,Active
		)
		VALUES
		(
					'''+CONVERT(VARCHAR(10),@Freight)+'''
					,'''+CONVERT(VARCHAR(10),@Labour)+'''
					,'''+CONVERT(VARCHAR(10),@Delivery)+'''
					,'''+CONVERT(VARCHAR(10),@Stationary)+'''
					,'''+CONVERT(VARCHAR(10),@Demurrage)+'''
					,'''+CONVERT(VARCHAR(10),@LocalCartage)+'''
					,'''+CONVERT(VARCHAR(10),@ServiceTax)+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END

SELECT @ChargesInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@ChargesInfoID INTEGER OUTPUT', @ChargesInfoID OUTPUT

SET @SQLString = N'BEGIN INSERT INTO '+@DBName+ '.dbo.AddressBook
					
		   (
            Name
			,SurName
			,OriCustName
			,GroupName
			,AgentCode
            ,AddressInfoID
            ,ChargesInfoID
			,Types
            ,PhonePrime
            ,PhoneSecondary
            ,EmailPrime
            ,EmailSecondary
			,Mob1
			,Mob2
            ,Website
            ,Fax
            ,TINNo
            ,CSTNo
            ,Areacode
			,BranchName
		    ,CreatedBy         
		    ,CreatedDate           
            ,Active
) 
	VALUES
(
           '''+UPPER(@Name)+'''
		   ,'''+UPPER(@SurName)+'''
		   ,'''+UPPER(@OriCustName)+'''
		   ,'''+UPPER(@GroupName)+'''
		   ,'''+@AgentCode+'''
           ,'''+cast(@AddressInfoID as nvarchar(3200))+'''
           ,'''+cast(@ChargesInfoID as nvarchar(3200))+'''
		   ,'''+@Category+'''
           ,'''+@PhonePrime+'''
           ,'''+@PhoneSecondary+'''
		   ,'''+@EmailPrime+'''
           ,'''+@EmailSecondary+'''
		   ,'''+@Mob1+'''
 		   ,'''+@Mob2+'''    
           ,'''+@Website+'''
           ,'''+@Fax+'''
           ,'''+@TINNo+'''
           ,'''+@CSTNo+'''
           ,'''+@Areacode+'''
		   ,'''+UPPER(@BranchName)+'''
           ,'''+@UserID+'''
		   ,'''+@GETDATE+'''
		   ,''True''
) 
END
SELECT @AddressBookInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@AddressBookInfoID INTEGER OUTPUT', @AddressBookInfoID OUTPUT
SELECT  @AddressBookInfoID


--EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString


BEGIN

	SET @SQLString = N'	INSERT INTO ' +@DBName+ '_Acc.dbo.Accounts
	(
		CreatedBy
		,Name
		,OriCustName
		,Status
		,Active
		,Types
		,Address
		,Pincode
		,City
		,GroupId
		,IsHiddenUser
		,BranchName
	)
	VALUES
	(
		'''+@UserID+'''
		,'''+Upper(@Name)+'''
		,'''+Upper(@OriCustName)+'''
		,1
		,1
		,'''+@Category+'''
		,'''+@Address+'''
		,'''+CONVERT(VARCHAR(15),@PinCode)+'''
		,'''+@City+'''
		,'''+CONVERT(VARCHAR(15),@GroupID)+'''
		,0
		,'''+@BranchName+'''
	)
'
EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END
END

=============================================================================================================================

CREATE PROC AddressFreight_I
@AddressID	INT
,@Packings	VARCHAR(50)
,@Weight	DECIMAL(18,2)
,@Fixed		DECIMAL(18,2)
,@BranchName VARCHAR(50)
,@UserID	VARCHAR(50)

as

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString=N'INSERT INTO '+@DBName+'.dbo.AddressFreightInfo
		(
			AddressID
			,Weight
			,Fixed
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
			'''+CONVERT(VARCHAR(10),@AddressID)+'''
			,'''+CONVERT(VARCHAR(10),@Weight)+'''
			,'''+CONVERT(VARCHAR(10),@Fixed)+'''
			,'''+@BranchName+'''
			,''True''			
			,'''+@UserID+'''
			,'''+@Getdate+'''
		)'
	EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


===========================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go










	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To Add Or Insert New record to the AddressBook and AddressInfo Table and Deepak_Acc.dbo.Accounts
		NOTE:  Inserting in TWO DATABASE(DeepakRoadways and Deepak_Acc)
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_I]
(
			@AgentCode VARCHAR(50)		 
			,@Address VARCHAR(50)		   
			,@Category VARCHAR(50)		   
			,@PinCode INT
			,@City VARCHAR(20)
			,@Name VARCHAR(50)   
			,@SurName VARCHAR(20) 
			,@OriCustName VARCHAR(25) 
			,@GroupName VARCHAR(25)
			,@GroupID  INT       
			,@PhonePrime varchar(20)
			,@PhoneSecondary varchar(20)
			,@Mob1 VARCHAR(15)
			,@Mob2 VARCHAR(15)
			,@EmailPrime varchar(40)
			,@EmailSecondary varchar(40)
			,@Website varchar(50)
			,@Fax varchar(30)
			,@TINNo varchar(30)
			,@CSTNo varchar(20)
			,@Areacode varchar(20) 
--			,@Freight DECIMAL(18,2)
			,@Labour DECIMAL(18,2)
			,@Delivery DECIMAL(18,2)
			,@Stationary DECIMAL(18,2)
			,@Demurrage DECIMAL(18,2)
			,@LocalCartage DECIMAL(18,2)
			,@ServiceTax DECIMAL(18,2)
			,@UserID varchar(25)
			,@BranchName varchar(50)
)
AS


BEGIN

DECLARE @AddressInfoID INT
DECLARE @ChargesInfoID INT
DECLARE @AddressBookInfoID INT

SET @PinCode=CONVERT(VARCHAR(15),@PinCode)

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

SET @SQLString = N'IF NOT EXISTS(SELECT Name FROM ' + @DBName + '.dbo.AddressBook WHERE Name='''+@Name+'''   AND BranchName=  '''+@BranchName+''' AND
									Active=''True'')
BEGIN
IF('+CONVERT(VARCHAR(15),@PinCode)+' != 0)
	BEGIN
		INSERT INTO ' +@DBName+'.dbo.AddressInfo
		(
					Address 
				    ,PinCode 
				    ,City 
					,BranchName
				    ,CreatedBy
				    ,CreatedDate
				    ,Active
		)
		VALUES
		(
					'''+@Address+'''
					,'''+CONVERT(VARCHAR(15),@PinCode)+'''
					,'''+@City+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END
	ELSE
	BEGIN
		INSERT INTO ' +@DBName+'.dbo.AddressInfo
		(
					Address 
					,City 
					,BranchName
					,CreatedBy
					,CreatedDate
					,Active
		)
		VALUES
		(
					'''+@Address+'''
					,'''+@City+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END
END
SELECT @AddressInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@AddressInfoID INTEGER OUTPUT', @AddressInfoID OUTPUT

SET @SQLString=N'BEGIN
		INSERT INTO ' +@DBName+'.dbo.AddressChargesInfo
		(
					Labour 
					,Delivery
					,Stationary
					,Demurrage
					,LocalCartage
					,ServiceTax
					,BranchName
					,CreatedBy
					,CreatedDate
					,Active
		)
		VALUES
		(
					'''+CONVERT(VARCHAR(10),@Labour)+'''
					,'''+CONVERT(VARCHAR(10),@Delivery)+'''
					,'''+CONVERT(VARCHAR(10),@Stationary)+'''
					,'''+CONVERT(VARCHAR(10),@Demurrage)+'''
					,'''+CONVERT(VARCHAR(10),@LocalCartage)+'''
					,'''+CONVERT(VARCHAR(10),@ServiceTax)+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END

SELECT @ChargesInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@ChargesInfoID INTEGER OUTPUT', @ChargesInfoID OUTPUT

SET @SQLString = N'BEGIN INSERT INTO '+@DBName+ '.dbo.AddressBook
					
		   (
            Name
			,SurName
			,OriCustName
			,GroupName
			,AgentCode
            ,AddressInfoID
            ,ChargesInfoID
			,Types
            ,PhonePrime
            ,PhoneSecondary
            ,EmailPrime
            ,EmailSecondary
			,Mob1
			,Mob2
            ,Website
            ,Fax
            ,TINNo
            ,CSTNo
            ,Areacode
			,BranchName
		    ,CreatedBy         
		    ,CreatedDate           
            ,Active
) 
	VALUES
(
           '''+UPPER(@Name)+'''
		   ,'''+UPPER(@SurName)+'''
		   ,'''+UPPER(@OriCustName)+'''
		   ,'''+UPPER(@GroupName)+'''
		   ,'''+@AgentCode+'''
           ,'''+cast(@AddressInfoID as nvarchar(3200))+'''
           ,'''+cast(@ChargesInfoID as nvarchar(3200))+'''
		   ,'''+@Category+'''
           ,'''+@PhonePrime+'''
           ,'''+@PhoneSecondary+'''
		   ,'''+@EmailPrime+'''
           ,'''+@EmailSecondary+'''
		   ,'''+@Mob1+'''
 		   ,'''+@Mob2+'''    
           ,'''+@Website+'''
           ,'''+@Fax+'''
           ,'''+@TINNo+'''
           ,'''+@CSTNo+'''
           ,'''+@Areacode+'''
		   ,'''+UPPER(@BranchName)+'''
           ,'''+@UserID+'''
		   ,'''+@GETDATE+'''
		   ,''True''
) 
END
SELECT @AddressBookInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@AddressBookInfoID INTEGER OUTPUT', @AddressBookInfoID OUTPUT
SELECT  @AddressBookInfoID


--EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString


BEGIN

	SET @SQLString = N'	INSERT INTO ' +@DBName+ '_Acc.dbo.Accounts
	(
		CreatedBy
		,Name
		,OriCustName
		,Status
		,Active
		,Types
		,Address
		,Pincode
		,City
		,GroupId
		,IsHiddenUser
		,BranchName
	)
	VALUES
	(
		'''+@UserID+'''
		,'''+Upper(@Name)+'''
		,'''+Upper(@OriCustName)+'''
		,1
		,1
		,'''+@Category+'''
		,'''+@Address+'''
		,'''+CONVERT(VARCHAR(15),@PinCode)+'''
		,'''+@City+'''
		,'''+CONVERT(VARCHAR(15),@GroupID)+'''
		,0
		,'''+@BranchName+'''
	)
'
EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END
END


=================================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go



















	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To View the record from the AddressBook and AddressInfo Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_S]
(
@Name  VARCHAR(30),
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
  SET @SQLString=N'IF EXISTS(SELECT * FROM ' + @DBName + '.dbo.AddressBook WHERE BranchName=''' + @BranchName + ''' 
					AND Name=''' + @Name + ''' AND Active=''True'')
	BEGIN
		SELECT 

			AB.ID,
			A.ID as AccountsID,
			AB.SurName,
			AB.OriCustName,
			AB.GroupName,
			AB.AgentCode,
			AB.AddressInfoID,
			AB.ChargesInfoID,
			AB.Types,
			AB.PhonePrime,
			AB.PhoneSecondary,
			AB.Mob1,
			AB.Mob2,
			AB.EmailPrime,
			AB.EmailSecondary,
			AB.Website,
			AB.Fax,
			AB.TINNo,
			AB.CSTNo,
			AB.Areacode,
			AD.Address,
			AD.City,
			AD.PinCode,
			ACI.Labour,
			ACI.Delivery,
			ACI.Stationary,
			ACI.Demurrage,
			ACI.LocalCartage,
			ACI.ServiceTax
			
	FROM
			' + @DBName + '.dbo.AddressBook (NOLOCK)AB INNER JOIN ' + @DBName + '.dbo.AddressInfo (NOLOCK) AD ON AB.AddressInfoID=AD.ID JOIN 
					' + @DBName + '_Acc.dbo.Accounts A ON A.[Name]=AB.[Name] LEFT JOIN ' + @DBName + '.dbo.AddressChargesInfo (NOLOCK) ACI
			ON ACI.ID=AB.ChargesInfoID
	WHERE
			AB.BranchName=''' + @BranchName + '''
	AND	
			AD.BranchName=''' + @BranchName + '''
	AND
			AB.[Name]=''' + @Name + '''
	AND 
			AB.Active=''True''
	

	END

	BEGIN
		SELECT
			AddressID
			,Packings
			,Weight
			,Fixed
		FROM
			AddressFreightInfo AFI
		JOIN
			AddressBook AB
		ON
			AFI.AddressID=AB.ID
		WHERE
			AB.Active=''True''
		AND
			AB.BranchName=''' + @BranchName + '''
		AND
			AFI.Active=''True''
	END
'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


===================================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go





	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To Update the record from the AddressBook and AddressInfo Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_U]
(
			@ContactID INT
			,@AccID INT
			,@ChargesID INT
            ,@AddressID int		
            ,@Category VARCHAR(20)		
            ,@Address VARCHAR(50)
		    ,@PinCode INT
		    ,@City VARCHAR(20)
            ,@Name varchar(30) 
			,@SurName varchar(30) 
			,@OriCustName varchar(30) 
			,@GroupName varchar(30)   
			,@GroupID INT   
			,@AgentCode varchar(30)      
            ,@PhonePrime varchar(20)
            ,@PhoneSecondary varchar(20)
			,@Mob1 VARCHAR(15)
			,@Mob2 VARCHAR(15)
            ,@EmailPrime varchar(40)
            ,@EmailSecondary varchar(40)
            ,@Website varchar(50)
            ,@Fax varchar(30)
            ,@TINNo varchar(30)
            ,@CSTNo varchar(20)
            ,@Areacode varchar(20)
			,@Labour DECIMAL(18,2)
			,@Delivery DECIMAL(18,2)
			,@Stationary DECIMAL(18,2)
			,@Demurrage DECIMAL(18,2)
			,@LocalCartage DECIMAL(18,2)
			,@ServiceTax DECIMAL(18,2)
			,@BranchName varchar(50)
		    ,@UserID varchar(25)
)
AS

DECLARE @ChargesInfoID INT

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'


BEGIN
SET @SQLString=N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@AddressID) + ''' AND Active=''True'')
BEGIN	
	if('''+ CONVERT(VARCHAR(15),@PinCode) + ''' != 0)
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressInfo
	SET
				Address=''' + Upper(@Address) + ''' 
			   ,PinCode=''' + CONVERT(VARCHAR(15),@PinCode) + '''
			   ,City=''' + Upper(@City) + '''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' +  CONVERT(VARCHAR(10),@AddressID) + ''' AND Active=''True''   
	END
ELSE
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressInfo
	SET
				Address=''' + Upper(@Address) + ''' 

			   ,City=''' + Upper(@City) + '''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' + CONVERT(VARCHAR(10),@AddressID) + ''' AND Active=''True''   
	END
END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

BEGIN
SET @SQLString=N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressChargesInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@ChargesID) + ''' AND Active=''True'')
BEGIN	
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressChargesInfo
	SET
			   Labour='''+CONVERT(VARCHAR(10),@Labour)+'''
			   ,Delivery='''+CONVERT(VARCHAR(10),@Delivery)+'''
			   ,Stationary='''+CONVERT(VARCHAR(10),@Stationary)+'''
			   ,Demurrage='''+CONVERT(VARCHAR(10),@Demurrage)+'''
			   ,LocalCartage='''+CONVERT(VARCHAR(10),@LocalCartage)+'''
			   ,ServiceTax='''+CONVERT(VARCHAR(10),@ServiceTax)+'''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' + CONVERT(VARCHAR(10),@ChargesID) + ''' AND Active=''True''   
	END
END'
EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

SET @SQLString=N'BEGIN IF NOT EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressChargesInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@ChargesID) + ''' AND Active=''True'')
		INSERT INTO ' +@DBName+'.dbo.AddressChargesInfo
		(
					,Labour 
					,Delivery
					,Stationary
					,Demurrage
					,LocalCartage
					,ServiceTax
					,BranchName
					,CreatedBy
					,CreatedDate
					,Active
		)
		VALUES
		(
					'''+CONVERT(VARCHAR(10),@Labour)+'''
					,'''+CONVERT(VARCHAR(10),@Delivery)+'''
					,'''+CONVERT(VARCHAR(10),@Stationary)+'''
					,'''+CONVERT(VARCHAR(10),@Demurrage)+'''
					,'''+CONVERT(VARCHAR(10),@LocalCartage)+'''
					,'''+CONVERT(VARCHAR(10),@ServiceTax)+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END

SELECT @ChargesInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@ChargesInfoID INTEGER OUTPUT', @ChargesInfoID OUTPUT


BEGIN
SET @SQLString = N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressBook WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(10),@ContactID) + ''' AND Active=''True'')
BEGIN
	UPDATE ' + @DBName + '.dbo.AddressBook
	SET				
            Name=''' + UPPER(@Name) + '''
			,SurName=''' + UPPER(@SurName) + '''
			,OriCustName=''' + UPPER(@OriCustName) + '''
			,ChargesInfoID='''+cast(@ChargesInfoID as nvarchar(3200))+'''
			,AgentCode=''' + @AgentCode + '''
			,Types=''' + @Category + '''
			,GroupName=''' + @GroupName + '''
		    ,PhonePrime=''' + @PhonePrime + '''
            ,PhoneSecondary=''' + @PhoneSecondary + '''
			,Mob1=''' + @Mob1 + '''
			,Mob2=''' + @Mob2 + '''
            ,EmailPrime=''' + UPPER(@EmailPrime) + '''
            ,EmailSecondary=''' + UPPER(@EmailSecondary) + '''
            ,Website=''' + UPPER(@Website) + '''
            ,Fax=''' + @Fax + '''
            ,TINNo=''' + @TINNo + '''
            ,CSTNo=''' + @CSTNo + '''
            ,Areacode=''' + @Areacode + '''
			,BranchName=''' + @BranchName + '''
		    ,Active=''True''
		    ,UpdatedBy=''' + @UserID + '''
		    ,UpdateDate=''' + @GETDATE + '''
	WHERE
			ID=''' + CONVERT(VARCHAR(10),@ContactID) + ''' AND Active=''True''
END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END
	
SET @SQLString = N'BEGIN UPDATE ' + @DBName + '_Acc.dbo.Accounts
	SET
		ModifyAt = ''' + @GETDATE + '''
		,ModifyBy = ''' + @UserID + '''
		,Name = ''' + UPPER(@Name) + '''
		,OriCustName = ''' + UPPER(@OriCustName) + '''
		,Status = ''1''
		,Address = ''' + @Address + '''
		,Pincode = ''' + CONVERT(VARCHAR(10),@Pincode) + '''
		,City = ''' + @City + '''
		,BranchName=''' + @BranchName + '''
		,GroupId = ''' + CONVERT(VARCHAR(10),@GroupID) + '''
		,IsHiddenUser = ''1''
	WHERE
		BranchName=''' + @BranchName + ''' AND ID=''' + CONVERT(VARCHAR(10),@AccID) + '''
END'


EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString


END


=====================================================================================================================================

ALTER PROC AddressFreight_U
@FreightID	INT
,@AddressFreightID	INT
,@Packings	VARCHAR(50)
,@Weight	VARCHAR(50)
,@Fixed		VARCHAR(50)
,@BranchName VARCHAR(50)
,@UserID	VARCHAR(50)

AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'


BEGIN
SET @SQLString=N'IF('''+CONVERT(VARCHAR(10),@FreightID)+'''!=0)
		BEGIN
			UPDATE ' + @DBName + '.dbo.AddressFreightInfo
			SET
				Packings='''+@Packings+'''
				,Weight='''+CONVERT(VARCHAR(10),@Weight)+'''
				,Fixed='''+CONVERT(VARCHAR(10),@Fixed)+'''
				,BranchName=''' + @BranchName + '''
				,Active=''True''
				,UpdatedBy=''' + @UserID + '''
				,UpdatedDate=''' + @GETDATE + '''
			WHERE
				ID=''' + CONVERT(VARCHAR(10),@FreightID) + ''' AND Active=''True''
			
			SELECT ''1''   
		END
		ELSE
		BEGIN
			INSERT INTO '+@DBName+'.dbo.AddressFreightInfo
		(
			AddressID
			,Packings
			,Weight
			,Fixed
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
			'''+CONVERT(VARCHAR(10),@AddressFreightID)+'''
			,'''+@Packings+'''
			,'''+CONVERT(VARCHAR(10),@Weight)+'''
			,'''+CONVERT(VARCHAR(10),@Fixed)+'''
			,'''+@BranchName+'''
			,''True''			
			,'''+@UserID+'''
			,'''+@Getdate+'''
		)
		
		SELECT ''1''
		
		UPDATE ' + @DBName + '.dbo.AddressFreightInfo
			SET
				Packings='''+@Packings+'''
				,Weight='''+CONVERT(VARCHAR(10),@Weight)+'''
				,Fixed='''+CONVERT(VARCHAR(10),@Fixed)+'''
				,BranchName=''' + @BranchName + '''
				,Active=''True''
				,UpdatedBy=''' + @UserID + '''
				,UpdatedDate=''' + @GETDATE + '''
			WHERE
				ID=''' + CONVERT(VARCHAR(10),@FreightID) + ''' AND Active=''True''
			
			SELECT ''1'' 
		END
'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


========================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To View the record from the AddressBook and AddressInfo Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_S]
(
@Name  VARCHAR(30),
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
  SET @SQLString=N'IF EXISTS(SELECT * FROM ' + @DBName + '.dbo.AddressBook WHERE BranchName=''' + @BranchName + ''' 
					AND Name=''' + @Name + ''' AND Active=''True'')
	BEGIN
		SELECT 

			AB.ID,
			A.ID as AccountsID,
			AB.SurName,
			AB.OriCustName,
			AB.GroupName,
			AB.AgentCode,
			AB.AddressInfoID,
			AB.ChargesInfoID,
			AB.Types,
			AB.PhonePrime,
			AB.PhoneSecondary,
			AB.Mob1,
			AB.Mob2,
			AB.EmailPrime,
			AB.EmailSecondary,
			AB.Website,
			AB.Fax,
			AB.TINNo,
			AB.CSTNo,
			AB.Areacode,
			AD.Address,
			AD.City,
			AD.PinCode,
			ACI.Labour,
			ACI.Delivery,
			ACI.Stationary,
			ACI.Demurrage,
			ACI.LocalCartage,
			ACI.ServiceTax
			
	FROM
			' + @DBName + '.dbo.AddressBook (NOLOCK)AB INNER JOIN ' + @DBName + '.dbo.AddressInfo (NOLOCK) AD ON AB.AddressInfoID=AD.ID JOIN 
					' + @DBName + '_Acc.dbo.Accounts A ON A.[Name]=AB.[Name] LEFT JOIN ' + @DBName + '.dbo.AddressChargesInfo (NOLOCK) ACI
			ON ACI.ID=AB.ChargesInfoID
	WHERE
			AB.BranchName=''' + @BranchName + '''
	AND	
			AD.BranchName=''' + @BranchName + '''
	AND
			AB.[Name]=''' + @Name + '''
	AND 
			AB.Active=''True''
	

	END

	BEGIN
		SELECT
			AFI.ID as FreightID
			,AddressID
			,Packings
			,Weight
			,Fixed
		FROM
			AddressFreightInfo AFI
		JOIN
			AddressBook AB
		ON
			AFI.AddressID=AB.ID
		WHERE
			AB.Active=''True''
		AND
			AB.BranchName=''' + @BranchName + '''
		AND
			AB.[Name]=''' + @Name + '''
		
		AND
			AFI.Active=''True''
	END
'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


=================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go






	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To Update the record from the AddressBook and AddressInfo Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_U]
(
			@ContactID INT
			,@AccID INT
			,@ChargesID INT
            ,@AddressID int		
            ,@Category VARCHAR(20)		
            ,@Address VARCHAR(50)
		    ,@PinCode INT
		    ,@City VARCHAR(20)
            ,@Name varchar(30) 
			,@SurName varchar(30) 
			,@OriCustName varchar(30) 
			,@GroupName varchar(30)   
			,@GroupID INT   
			,@AgentCode varchar(30)      
            ,@PhonePrime varchar(20)
            ,@PhoneSecondary varchar(20)
			,@Mob1 VARCHAR(15)
			,@Mob2 VARCHAR(15)
            ,@EmailPrime varchar(40)
            ,@EmailSecondary varchar(40)
            ,@Website varchar(50)
            ,@Fax varchar(30)
            ,@TINNo varchar(30)
            ,@CSTNo varchar(20)
            ,@Areacode varchar(20)
			,@Labour DECIMAL(18,2)
			,@Delivery DECIMAL(18,2)
			,@Stationary DECIMAL(18,2)
			,@Demurrage DECIMAL(18,2)
			,@LocalCartage DECIMAL(18,2)
			,@ServiceTax DECIMAL(18,2)
			,@BranchName varchar(50)
		    ,@UserID varchar(25)
)
AS

DECLARE @ChargesInfoID INT

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'


BEGIN
SET @SQLString=N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@AddressID) + ''' AND Active=''True'')
BEGIN	
	if('''+ CONVERT(VARCHAR(15),@PinCode) + ''' != 0)
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressInfo
	SET
				Address=''' + Upper(@Address) + ''' 
			   ,PinCode=''' + CONVERT(VARCHAR(15),@PinCode) + '''
			   ,City=''' + Upper(@City) + '''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' +  CONVERT(VARCHAR(10),@AddressID) + ''' AND Active=''True''   
	END
ELSE
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressInfo
	SET
				Address=''' + Upper(@Address) + ''' 

			   ,City=''' + Upper(@City) + '''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' + CONVERT(VARCHAR(10),@AddressID) + ''' AND Active=''True''   
	END
END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

BEGIN
SET @SQLString=N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressChargesInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@ChargesID) + ''' AND Active=''True'')
BEGIN	
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressChargesInfo
	SET
			   Labour='''+CONVERT(VARCHAR(10),@Labour)+'''
			   ,Delivery='''+CONVERT(VARCHAR(10),@Delivery)+'''
			   ,Stationary='''+CONVERT(VARCHAR(10),@Stationary)+'''
			   ,Demurrage='''+CONVERT(VARCHAR(10),@Demurrage)+'''
			   ,LocalCartage='''+CONVERT(VARCHAR(10),@LocalCartage)+'''
			   ,ServiceTax='''+CONVERT(VARCHAR(10),@ServiceTax)+'''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' + CONVERT(VARCHAR(10),@ChargesID) + ''' AND Active=''True''   
	END
END'
EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

SET @SQLString=N'BEGIN IF NOT EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressChargesInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@ChargesID) + ''' AND Active=''True'')
		INSERT INTO ' +@DBName+'.dbo.AddressChargesInfo
		(
					Labour 
					,Delivery
					,Stationary
					,Demurrage
					,LocalCartage
					,ServiceTax
					,BranchName
					,CreatedBy
					,CreatedDate
					,Active
		)
		VALUES
		(
					'''+CONVERT(VARCHAR(10),@Labour)+'''
					,'''+CONVERT(VARCHAR(10),@Delivery)+'''
					,'''+CONVERT(VARCHAR(10),@Stationary)+'''
					,'''+CONVERT(VARCHAR(10),@Demurrage)+'''
					,'''+CONVERT(VARCHAR(10),@LocalCartage)+'''
					,'''+CONVERT(VARCHAR(10),@ServiceTax)+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END

SELECT @ChargesInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@ChargesInfoID INTEGER OUTPUT', @ChargesInfoID OUTPUT


BEGIN
SET @SQLString = N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressBook WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(10),@ContactID) + ''' AND Active=''True'')
BEGIN
	UPDATE ' + @DBName + '.dbo.AddressBook
	SET				
            Name=''' + UPPER(@Name) + '''
			,SurName=''' + UPPER(@SurName) + '''
			,OriCustName=''' + UPPER(@OriCustName) + '''
			,ChargesInfoID='''+cast(@ChargesInfoID as nvarchar(3200))+'''
			,AgentCode=''' + @AgentCode + '''
			,Types=''' + @Category + '''
			,GroupName=''' + @GroupName + '''
		    ,PhonePrime=''' + @PhonePrime + '''
            ,PhoneSecondary=''' + @PhoneSecondary + '''
			,Mob1=''' + @Mob1 + '''
			,Mob2=''' + @Mob2 + '''
            ,EmailPrime=''' + UPPER(@EmailPrime) + '''
            ,EmailSecondary=''' + UPPER(@EmailSecondary) + '''
            ,Website=''' + UPPER(@Website) + '''
            ,Fax=''' + @Fax + '''
            ,TINNo=''' + @TINNo + '''
            ,CSTNo=''' + @CSTNo + '''
            ,Areacode=''' + @Areacode + '''
			,BranchName=''' + @BranchName + '''
		    ,Active=''True''
		    ,UpdatedBy=''' + @UserID + '''
		    ,UpdateDate=''' + @GETDATE + '''
	WHERE
			ID=''' + CONVERT(VARCHAR(10),@ContactID) + ''' AND Active=''True''
END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString
SELECT '1'
END
	
SET @SQLString = N'BEGIN UPDATE ' + @DBName + '_Acc.dbo.Accounts
	SET
		ModifyAt = ''' + @GETDATE + '''
		,ModifyBy = ''' + @UserID + '''
		,Name = ''' + UPPER(@Name) + '''
		,OriCustName = ''' + UPPER(@OriCustName) + '''
		,Status = ''1''
		,Address = ''' + @Address + '''
		,Pincode = ''' + CONVERT(VARCHAR(10),@Pincode) + '''
		,City = ''' + @City + '''
		,BranchName=''' + @BranchName + '''
		,GroupId = ''' + CONVERT(VARCHAR(10),@GroupID) + '''
		,IsHiddenUser = ''1''
	WHERE
		BranchName=''' + @BranchName + ''' AND ID=''' + CONVERT(VARCHAR(10),@AccID) + '''
END'


EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString


END

===============================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go



	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To View the record from the AddressBook and AddressInfo Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_S]
(
@Name  VARCHAR(30),
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
  SET @SQLString=N'IF EXISTS(SELECT * FROM ' + @DBName + '.dbo.AddressBook WHERE BranchName=''' + @BranchName + ''' 
					AND Name=''' + @Name + ''' AND Active=''True'')
	BEGIN
		SELECT 

			AB.ID,
			A.ID as AccountsID,
			AB.SurName,
			AB.OriCustName,
			AB.GroupName,
			AB.AgentCode,
			AB.AddressInfoID,
			AB.ChargesInfoID,
			AB.Types,
			AB.PhonePrime,
			AB.PhoneSecondary,
			AB.Mob1,
			AB.Mob2,
			AB.EmailPrime,
			AB.EmailSecondary,
			AB.Website,
			AB.Fax,
			AB.TINNo,
			AB.CSTNo,
			AB.Areacode,
			AD.Address,
			AD.City,
			AD.PinCode,
			ACI.Labour,
			ACI.Delivery,
			ACI.Stationary,
			ACI.Demurrage,
			ACI.LocalCartage,
			ACI.ServiceTax
			
	FROM
			' + @DBName + '.dbo.AddressBook (NOLOCK)AB INNER JOIN ' + @DBName + '.dbo.AddressInfo (NOLOCK) AD ON AB.AddressInfoID=AD.ID JOIN 
					' + @DBName + '_Acc.dbo.Accounts A ON A.[Name]=AB.[Name] LEFT JOIN ' + @DBName + '.dbo.AddressChargesInfo (NOLOCK) ACI
			ON ACI.ID=AB.ChargesInfoID
	WHERE
			AB.BranchName=''' + @BranchName + '''
	AND	
			AD.BranchName=''' + @BranchName + '''
	AND
			AB.[Name]=''' + @Name + '''
	AND 
			AB.Active=''True''
	

	
		SELECT
			AFI.ID as FreightID
			,AddressID
			,Packings
			,Weight
			,Fixed
		FROM
			AddressFreightInfo AFI
		JOIN
			AddressBook AB
		ON
			AFI.AddressID=AB.ID
		WHERE
			AB.Active=''True''
		AND
			AB.BranchName=''' + @BranchName + '''
		AND
			AB.[Name]=''' + @Name + '''
		
		AND
			AFI.Active=''True''
	END
'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


===================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go




	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To View the record from the AddressBook and AddressInfo Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_S]
(
@Name  VARCHAR(30),
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
  SET @SQLString=N'IF EXISTS(SELECT * FROM ' + @DBName + '.dbo.AddressBook WHERE BranchName=''' + @BranchName + ''' 
					AND Name=''' + @Name + ''' AND Active=''True'')
	BEGIN
		SELECT 

			AB.ID,
			A.ID as AccountsID,
			AB.SurName,
			AB.OriCustName,
			AB.GroupName,
			AB.AgentCode,
			AB.AddressInfoID,
			AB.ChargesInfoID,
			AB.Types,
			AB.PhonePrime,
			AB.PhoneSecondary,
			AB.Mob1,
			AB.Mob2,
			AB.EmailPrime,
			AB.EmailSecondary,
			AB.Website,
			AB.Fax,
			AB.TINNo,
			AB.CSTNo,
			AB.Areacode,
			AD.Address,
			AD.City,
			AD.PinCode,
			ACI.Labour,
			ACI.Delivery,
			ACI.Stationary,
			ACI.Demurrage,
			ACI.LocalCartage,
			ACI.ServiceTax
			
	FROM
			' + @DBName + '.dbo.AddressBook (NOLOCK)AB INNER JOIN ' + @DBName + '.dbo.AddressInfo (NOLOCK) AD ON AB.AddressInfoID=AD.ID JOIN 
					' + @DBName + '_Acc.dbo.Accounts A ON A.[Name]=AB.[Name] LEFT JOIN ' + @DBName + '.dbo.AddressChargesInfo (NOLOCK) ACI
			ON ACI.ID=AB.ChargesInfoID
	WHERE
			AB.BranchName=''' + @BranchName + '''
	AND	
			AD.BranchName=''' + @BranchName + '''
	AND
			AB.[Name]=''' + @Name + '''
	AND 
			AB.Active=''True''
	

	
		SELECT
			AFI.ID as FreightID
			,AFI.AddressID
			,AFI.Packings
			,AFI.Weight
			,AFI.Fixed
		FROM
			AddressFreightInfo AFI
		JOIN
			AddressBook AB
		ON
			AFI.AddressID=AB.ID
		WHERE
			AB.Active=''True''
		AND
			AB.BranchName=''' + @BranchName + '''
		AND
			AB.[Name]=''' + @Name + '''
		
		AND
			AFI.Active=''True''
	END
'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END
=================================================================================================================================

CREATE PROC [dbo].[AddressFreight_Row_D]
(
@ID int,
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString = N'UPDATE
		' + @DBName + '.dbo.AddressFreightInfo 
	SET
		Active=''False''
	WHERE
		ID='''+CONVERT(VARCHAR(10),@ID)+'''
	AND
		BranchName='''+@BranchName+'''
	AND
		Active=''True'''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

======================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go







	/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 19-12-2011
		DESCRIPTION : To Update the record from the AddressBook and AddressInfo Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROCEDURE [dbo].[AddressBook_U]
(
			@ContactID INT
			,@AccID INT
			,@ChargesID INT
            ,@AddressID int		
            ,@Category VARCHAR(20)		
            ,@Address VARCHAR(50)
		    ,@PinCode INT
		    ,@City VARCHAR(20)
            ,@Name varchar(30) 
			,@SurName varchar(30) 
			,@OriCustName varchar(30) 
			,@GroupName varchar(30)   
			,@GroupID INT   
			,@AgentCode varchar(30)      
            ,@PhonePrime varchar(20)
            ,@PhoneSecondary varchar(20)
			,@Mob1 VARCHAR(15)
			,@Mob2 VARCHAR(15)
            ,@EmailPrime varchar(40)
            ,@EmailSecondary varchar(40)
            ,@Website varchar(50)
            ,@Fax varchar(30)
            ,@TINNo varchar(30)
            ,@CSTNo varchar(20)
            ,@Areacode varchar(20)
			,@Labour DECIMAL(18,2)
			,@Delivery DECIMAL(18,2)
			,@Stationary DECIMAL(18,2)
			,@Demurrage DECIMAL(18,2)
			,@LocalCartage DECIMAL(18,2)
			,@ServiceTax DECIMAL(18,2)
			,@BranchName varchar(50)
		    ,@UserID varchar(25)
)
AS

DECLARE @ChargesInfoID INT

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'


BEGIN
SET @SQLString=N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@AddressID) + ''' AND Active=''True'')
BEGIN	
	if('''+ CONVERT(VARCHAR(15),@PinCode) + ''' != 0)
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressInfo
	SET
				Address=''' + Upper(@Address) + ''' 
			   ,PinCode=''' + CONVERT(VARCHAR(15),@PinCode) + '''
			   ,City=''' + Upper(@City) + '''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' +  CONVERT(VARCHAR(10),@AddressID) + ''' AND Active=''True''   
	END
ELSE
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressInfo
	SET
				Address=''' + Upper(@Address) + ''' 

			   ,City=''' + Upper(@City) + '''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' + CONVERT(VARCHAR(10),@AddressID) + ''' AND Active=''True''   
	END
END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

BEGIN
SET @SQLString=N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressChargesInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@ChargesID) + ''' AND Active=''True'')
BEGIN	
	BEGIN
	UPDATE ' + @DBName + '.dbo.AddressChargesInfo
	SET
			   Labour='''+CONVERT(VARCHAR(10),@Labour)+'''
			   ,Delivery='''+CONVERT(VARCHAR(10),@Delivery)+'''
			   ,Stationary='''+CONVERT(VARCHAR(10),@Stationary)+'''
			   ,Demurrage='''+CONVERT(VARCHAR(10),@Demurrage)+'''
			   ,LocalCartage='''+CONVERT(VARCHAR(10),@LocalCartage)+'''
			   ,ServiceTax='''+CONVERT(VARCHAR(10),@ServiceTax)+'''
			   ,BranchName=''' + @BranchName + '''
			   ,Active=''True''
			   ,UpdatedBy=''' + @UserID + '''
			   ,UpdatedDate=''' + @GETDATE + '''
	WHERE 
				ID=''' + CONVERT(VARCHAR(10),@ChargesID) + ''' AND Active=''True''   
	END
END'
EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

SET @SQLString=N'BEGIN IF NOT EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressChargesInfo WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(15),@ChargesID) + ''' AND Active=''True'')
		INSERT INTO ' +@DBName+'.dbo.AddressChargesInfo
		(
					Labour 
					,Delivery
					,Stationary
					,Demurrage
					,LocalCartage
					,ServiceTax
					,BranchName
					,CreatedBy
					,CreatedDate
					,Active
		)
		VALUES
		(
					'''+CONVERT(VARCHAR(10),@Labour)+'''
					,'''+CONVERT(VARCHAR(10),@Delivery)+'''
					,'''+CONVERT(VARCHAR(10),@Stationary)+'''
					,'''+CONVERT(VARCHAR(10),@Demurrage)+'''
					,'''+CONVERT(VARCHAR(10),@LocalCartage)+'''
					,'''+CONVERT(VARCHAR(10),@ServiceTax)+'''
					,'''+@BranchName+''' 
					,'''+@UserID+'''
					,'''+@GETDATE+'''
					,''True''
		)
	END

SELECT @ChargesInfoID =SCOPE_IDENTITY()'
EXEC sp_executesql @SQLString,N'@ChargesInfoID INTEGER OUTPUT', @ChargesInfoID OUTPUT


BEGIN
SET @SQLString = N'IF EXISTS (SELECT ''*'' FROM ' + @DBName + '.dbo.AddressBook WHERE BranchName=''' + @BranchName + ''' 
					AND ID=''' + CONVERT(VARCHAR(10),@ContactID) + ''' AND Active=''True'')
BEGIN
	UPDATE ' + @DBName + '.dbo.AddressBook
	SET				
            Name=''' + UPPER(@Name) + '''
			,SurName=''' + UPPER(@SurName) + '''
			,OriCustName=''' + UPPER(@OriCustName) + '''
			,AgentCode=''' + @AgentCode + '''
			,Types=''' + @Category + '''
			,GroupName=''' + @GroupName + '''
		    ,PhonePrime=''' + @PhonePrime + '''
            ,PhoneSecondary=''' + @PhoneSecondary + '''
			,Mob1=''' + @Mob1 + '''
			,Mob2=''' + @Mob2 + '''
            ,EmailPrime=''' + UPPER(@EmailPrime) + '''
            ,EmailSecondary=''' + UPPER(@EmailSecondary) + '''
            ,Website=''' + UPPER(@Website) + '''
            ,Fax=''' + @Fax + '''
            ,TINNo=''' + @TINNo + '''
            ,CSTNo=''' + @CSTNo + '''
            ,Areacode=''' + @Areacode + '''
			,BranchName=''' + @BranchName + '''
		    ,Active=''True''
		    ,UpdatedBy=''' + @UserID + '''
		    ,UpdateDate=''' + @GETDATE + '''
	WHERE
			ID=''' + CONVERT(VARCHAR(10),@ContactID) + ''' AND Active=''True''
END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString
--SELECT '1'
END
	
SET @SQLString = N'BEGIN UPDATE ' + @DBName + '_Acc.dbo.Accounts
	SET
		ModifyAt = ''' + @GETDATE + '''
		,ModifyBy = ''' + @UserID + '''
		,Name = ''' + UPPER(@Name) + '''
		,OriCustName = ''' + UPPER(@OriCustName) + '''
		,Status = ''1''
		,Address = ''' + @Address + '''
		,Pincode = ''' + CONVERT(VARCHAR(10),@Pincode) + '''
		,City = ''' + @City + '''
		,BranchName=''' + @BranchName + '''
		,GroupId = ''' + CONVERT(VARCHAR(10),@GroupID) + '''
		,IsHiddenUser = ''1''
	WHERE
		BranchName=''' + @BranchName + ''' AND ID=''' + CONVERT(VARCHAR(10),@AccID) + '''
END'


EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString


END


==============================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go








ALTER PROC [dbo].[DeliverySlip_View]
(
@LRNO INT,
@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString = N'SELECT 
		LCD.ID
		,Convert(Varchar(20),LCD.LRDate,103) as Date
		,LCD.CustName
		,LCD.OriCustName
		,LCD.LRNo
		,LCD.NoOfPackages
		,LCD.Contents
		,LCD.Weight as TotalWeight
--		,ISNULL(ACI.Freight,0) as Freight
		,ISNULL(ACI.Labour,0) as Labour
		,ISNULL(ACI.Delivery,0) as Delivery
		,ISNULL(ACI.Stationary,0) as Stationary
		,ISNULL(ACI.Demurrage,0) as Demurrage
		,ISNULL(ACI.LocalCartage,0) as LocalCartage
		,ISNULL(ACI.ServiceTax,0) as ServiceTax
	FROM
		' + @DBName + '.dbo.LorryChallan LC
	JOIN 
		' + @DBName + '.dbo.LorryChallanDescription LCD
	ON
		LC.ID=LCD.LorryChallanID
	JOIN
		' + @DBName + '.dbo.AddressBook AB
	ON
		LCD.CustName=AB.Name
	LEFT JOIN
		' + @DBName + '.dbo.AddressChargesInfo ACI
	ON
		ACI.ID=AB.ChargesInfoID
	WHERE
		LRNO='''+CONVERT(VARCHAR(10),@LRNO)+'''
	AND
		LC.BranchName='''+@BranchName+'''
	AND
		AB.Active=''True''
	AND
		LC.Active=''True''
	AND
		LCD.Active=''True''

	SELECT 
		AFI.ID,AFI.Packings 
	FROM
		' + @DBName + '.dbo.LorryChallan LC
	JOIN 
		' + @DBName + '.dbo.LorryChallanDescription LCD
	ON
		LC.ID=LCD.LorryChallanID
	JOIN
		' + @DBName + '.dbo.AddressBook AB
	ON
		LCD.CustName=AB.Name
	LEFT JOIN
		' + @DBName + '.dbo.AddressChargesInfo ACI
	ON
		ACI.ID=AB.ChargesInfoID
	LEFT JOIN
		' + @DBName + '.dbo.AddressFreightInfo AFI
	ON
		AFI.AddressID=AB.ID
	WHERE
		LRNO='''+CONVERT(VARCHAR(10),@LRNO)+'''
	AND
		LC.BranchName='''+@BranchName+'''
	AND
		AB.Active=''True''
	AND
		LC.Active=''True''
	AND
		LCD.Active=''True''

	
'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END


====================================================================================================================================

CREATE PROC DeliverySlip_Packings_Change
(
	@PackID INT
	,@BranchName VARCHAR(50)
)

AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString = N'SELECT 
							Weight as FreightWeight
						FROM
							' + @DBName + '.dbo.AddressFreightInfo
						WHERE
							ID='''+CONVERT(VARCHAR(10),@PackID)+'''
						AND
							BranchName='''+@BranchName+'''
						AND
							Active=''True'''

	EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

====================================================================================================================================

CREATE PROC DeliverySlip_Packings_Fixed
(
	@PackID INT
	,@BranchName VARCHAR(50)
)

AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString = N'SELECT 
							Fixed as FreightFixed
						FROM
							' + @DBName + '.dbo.AddressFreightInfo
						WHERE
							ID='''+CONVERT(VARCHAR(10),@PackID)+'''
						AND
							BranchName='''+@BranchName+'''
						AND
							Active=''True'''

	EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

====================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go










ALTER PROC [dbo].[DeliverySlip_U]
(
	@LRNO				VARCHAR(25)
	,@MRNO				VARCHAR(25)
	,@DeliverySlipID	INT
	,@ActWeight			DECIMAL(18,2)
	,@Packing			VARCHAR(25)	
	,@PrivateMarks		VARCHAR(150)	
	,@Freight			DECIMAL(18,2)
	,@Labour			DECIMAL(18,2)		
	,@DeliveryCh		DECIMAL(18,2)		
	,@StationaryCh		DECIMAL(18,2)		
	,@Demurrage			DECIMAL(18,2)		
	,@LocalCartage		DECIMAL(18,2)		
	,@ServiceTax		DECIMAL(18,2)		
	,@DeliveryDate		DATETIME
	,@CustomerName		VARCHAR(30)
	,@OriCustName		VARCHAR(30)
	,@BranchName		VARCHAR(50)
	,@UserID			VARCHAR(25)
)

AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @LorryDescID INT
DECLARE @LDescID INT
DECLARE @ToPay DECIMAL
DECLARE @Amount DECIMAL
DECLARE @TotFreight DECIMAL(18,2)
DECLARE @TotService DECIMAL(18,2)
DECLARE @Amt DECIMAL
DECLARE @ContactID INT
DECLARE @OldAmt DECIMAL
DECLARE @TotalBalance DECIMAL
DECLARE @Total DECIMAL(18,2)
DECLARE @CName VARCHAR(25)

SET @SQLString=N'(SELECT @CName=CustomerName FROM '+@DBName+'.dbo.DeliverySlip WHERE ID='+CONVERT(VARCHAR(10),@DeliverySlipID)+'
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@CName VARCHAR(20) OUTPUT', @CName OUTPUT

SET @SQLString=N'(SELECT @LorryDescID=LorryChallanDescID FROM '+@DBName+'.dbo.DeliverySlip WHERE ID='+CONVERT(VARCHAR(10),@DeliverySlipID)+'
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@LorryDescID INTEGER OUTPUT', @LorryDescID OUTPUT

SET @SQLString=N'(SELECT @LDescID=ID FROM '+@DBName+'.dbo.LorryChallanDescription WHERE LRNo='+CONVERT(VARCHAR(10),@LRNo)+'
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@LDescID INTEGER OUTPUT', @LDescID OUTPUT

SET @TotFreight=(SELECT (@ActWeight * @Freight))

SET @TotService=(SELECT (@ActWeight * @Freight) * @ServiceTax)

SET @Amount=(SELECT (@TotFreight + @Labour + @DeliveryCh + @StationaryCh +@Demurrage + @LocalCartage + @TotService) )

SET @SQLString=N'(SELECT @ContactID=ID FROM '+@DBName+'.dbo.AddressBook WHERE [Name]='''+@CustomerName+'''
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@ContactID INTEGER OUTPUT', @ContactID OUTPUT

SET @SQLString=N'(SELECT @ToPay=(Freight + Labour + DeliveryCh + StationaryCh + Demurrage + LocalCartage + ServiceTax) 
					FROM ' + @DBName + '.dbo.DeliverySlip WHERE ID='+CONVERT(VARCHAR(10),@DeliverySlipID)+' 
					AND BranchName='''+@BranchName+''' AND ACTIVE=''True'')'

EXEC sp_executesql @SQLString,N'@ToPay INTEGER OUTPUT', @ToPay OUTPUT

DECLARE @AccID INT
	
SET @SQLString=N'(SELECT @AccID=ID FROM ' + @DBName + '_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+'''
					 AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT

DECLARE @AccOriCustID INT
	
SET @SQLString=N'(SELECT @AccOriCustID=ID FROM ' + @DBName + '_Acc.dbo.Accounts WHERE [Name]='''+@OriCustName+'''
					 AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@AccOriCustID INTEGER OUTPUT', @AccOriCustID OUTPUT

DECLARE @EntryITCount INT

SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount)'

EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT

DECLARE @TimeDate as datetime
	DECLARE @Time datetime
	SET @Time=(SELECT
	CONVERT(VARCHAR(8),GETDATE(),108) AS ForTime)      
	SET @TimeDate=@DeliveryDate+@Time

BEGIN
	SET @SQLString=N'IF NOT EXISTS(SELECT * FROM '+@DBName+'.dbo.Payments WHERE MRNO='''+@MRNO+''' 
					AND BranchName='''+@BranchName+''' AND Active=''True'')
	BEGIN
		UPDATE
			' + @DBName +'.dbo.DeliverySlip
		SET
			MRNO='''+CONVERT(VARCHAR(20),@MRNO)+'''
			,LorryChallanDescID='''+CONVERT(VARCHAR(10),@LDescID)+'''
			,CustomerName='''+@CustomerName+'''
			,OriCustName='''+@OriCustName+'''
			,ActualWeight='''+CONVERT(VARCHAR(10),@ActWeight)+'''
			,Packing='''+@Packing+'''
			,PrivateMarks='''+@PrivateMarks+'''
			,Freight='''+CONVERT(VARCHAR(10),@Freight)+'''
			,Labour='''+CONVERT(VARCHAR(10),@Labour)+'''
			,DeliveryCh='''+CONVERT(VARCHAR(10),@DeliveryCh)+'''
			,StationaryCh='''+CONVERT(VARCHAR(10),@StationaryCh)+'''
			,Demurrage='''+CONVERT(VARCHAR(10),@Demurrage)+'''
			,LocalCartage='''+CONVERT(VARCHAR(10),@LocalCartage)+'''
			,ServiceTax='''+CONVERT(VARCHAR(10),@ServiceTax)+'''
			,DeliveryDate='''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
			,Amount='''+CONVERT(VARCHAR(10),@Amount)+'''
			,Balance='''+CONVERT(VARCHAR(10),@Amount)+'''
			,PaymentStatus=''True''
			,BranchName='''+@BranchName+'''
			,UpdatedBy='''+@UserID+'''
			,UpdatedDate='''+@GETDATE+'''
		WHERE
			ID='''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
		AND
			Active=''True''
	END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString	


	SET @SQLString=N'IF NOT EXISTS(SELECT * FROM '+@DBName+'.dbo.Payments WHERE MRNO='''+@MRNO+''' 
					AND BranchName='''+@BranchName+''' AND Active=''True'')
		BEGIN

		IF('''+CONVERT(VARCHAR(10),@LDescID)+'''='''+CONVERT(VARCHAR(10),@LorryDescID)+''')
			BEGIN

				UPDATE
						' + @DBName + '.dbo.LorryChallanDescription
				SET
						ToPay='''+CONVERT(VARCHAR(10),@Amount)+'''
				WHERE
						ID='''+CONVERT(VARCHAR(10),@LorryDescID)+'''
				AND 
						BranchName='''+@BranchName+'''
				AND
						Active=''True''
			END
		ELSE
			BEGIN
				UPDATE
					' + @DBName + '.dbo.LorryChallanDescription
				SET
					ToPay='''+CONVERT(VARCHAR(10),@Amount)+'''
				WHERE
					LRNo='''+@LRNO+'''
				AND 
					BranchName='''+@BranchName+'''
				AND
					Active=''True''
				
				UPDATE
						' + @DBName + '.dbo.LorryChallanDescription
				SET
						ToPay=0
				WHERE
						ID='''+CONVERT(VARCHAR(10),@LorryDescID)+'''
				AND 
						BranchName='''+@BranchName+'''
				AND
						Active=''True''
			END

		IF('''+@CName+'''!=''Cancelled'')
				BEGIN
					
					UPDATE 
							' + @DBName + '_Acc.dbo.DebitsCredits
					SET
							Amount='''+CONVERT(VARCHAR(10),@Amount)+''',
							AccountID='''+CONVERT(VARCHAR(10),@AccID)+''',
							AccOriCustID='''+CONVERT(VARCHAR(10),@AccOriCustID)+''',
							Date='''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+''',
							ModifyAt='''+@GETDATE+''',
							ModifyBY='''+@UserID+''',
							RelationAccount='''+@CustomerName+'''
					
					WHERE
							DeliveryID='''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''


					UPDATE 
						' + @DBName + '.dbo.DailyBalance
					SET
						ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''',
						Date='''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+''',
						Balance='''+CONVERT(VARCHAR(10),@Amount)+''',
						TotBalance='''+CONVERT(VARCHAR(10),@Amount)+''',
						UpdatedBy='''+@UserID+''',
						UpdatedDate='''+@GETDATE+'''
					WHERE
						DeliveryId='''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
					AND 
						BranchName='''+@BranchName+'''
					AND
						Active=''True''

				END
		ELSE
		   BEGIN

				UPDATE 
					' + @DBName + '_Acc.dbo.Company_EntryItemCount
				SET
					ItemCount=ItemCount+1

			IF('''+@CustomerName+'''=''Cash'')
				BEGIN

					INSERT INTO ' + @DBName + '_Acc.dbo.DebitsCredits
						(
							Date
							,AccountID
							,AccOriCustID
							,DeliveryID
							,Amount
							,BranchName
							,CreatedAt
							,CreatedBy
							,Type
							,Status
							,Particular
							,RelationAccount
						)
					   VALUES
						(
							'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
							,'''+CONVERT(VARCHAR(10),@AccID)+'''
							,'''+CONVERT(VARCHAR(10),@AccOriCustID)+'''
							,'''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
							,'''+CONVERT(VARCHAR(10),@Amount)+'''
							,'''+@BranchName+'''
							,'''+@GETDATE+'''
							,'''+@UserID+'''
							,''Cr''
							,1
							,''MRNo'' + '' '' + ''' + CONVERT(VARCHAR(20),@MRNo) + '''
							,'''+@CustomerName+'''
						)

					END
				ELSE
					BEGIN
						INSERT INTO ' + @DBName + '_Acc.dbo.DebitsCredits
							(
								Date
								,AccountID
								,AccOriCustID
								,DeliveryID
								,Amount
								,BranchName
								,CreatedAt
								,CreatedBy
								,Type
								,Status
								,Particular
								,RelationAccount
							)
						VALUES
							(
								'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
								,'''+CONVERT(VARCHAR(10),@AccID)+'''
								,'''+CONVERT(VARCHAR(10),@AccOriCustID)+'''
								,'''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
								,'''+CONVERT(VARCHAR(10),@Amount)+'''
								,'''+@BranchName+'''
								,'''+@GETDATE+'''
								,'''+@UserID+'''
								,''Dr''
								,1
								,''MRNo'' + '' '' + ''' + CONVERT(VARCHAR(20),@MRNo) +'''
								,'''+@CustomerName+'''
							)
					END
		
	 

			INSERT INTO ' + @DBName + '.dbo.DailyBalance
				(
					ContactID
					,DeliveryID
					,Date
					,Balance
					,TotBalance
					,BranchName
					,Active
					,CreatedBy
					,CreatedDate
				)
				VALUES
				(
					'''+CONVERT(VARCHAR(10),@ContactID)+''',
					'''+CONVERT(VARCHAR(10),@DeliverySlipID)+''',
					'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+''',
					'''+CONVERT(VARCHAR(10),@Amount)+''',
					'''+CONVERT(VARCHAR(10),@Amount)+''',
					'''+@BranchName+''',
					''True'',
					'''+@UserID+''',
					'''+@GETDATE+'''
				)
			END	
	END'


EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString	

END

===============================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


ALTER PROC [dbo].[DeliverySlip_Cust_Check]
(
@CustomerName Varchar(50)
,@BranchName VARCHAR(50)
)

AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'



BEGIN
	SET @SQLString = N'SELECT 
		AB.OriCustName
		,ISNULL(ACI.Labour,0) as Labour
		,ISNULL(ACI.Delivery,0) as Delivery
		,ISNULL(ACI.Stationary,0) as Stationary
		,ISNULL(ACI.Demurrage,0) as Demurrage
		,ISNULL(ACI.LocalCartage,0) as LocalCartage
		,ISNULL(ACI.ServiceTax,0) as ServiceTax
	FROM
		' + @DBName + '.dbo.AddressBook AB
	LEFT JOIN
		' + @DBName + '.dbo.AddressChargesInfo ACI
	ON
		ACI.ID=AB.ChargesInfoID
	WHERE
		Name='''+@CustomerName+'''
	AND
		AB.Active=''True''
	




	SELECT 
		AFI.ID,AFI.Packings 
	FROM
		' + @DBName + '.dbo.AddressBook AB
	LEFT JOIN
		' + @DBName + '.dbo.AddressChargesInfo ACI
	ON
		ACI.ID=AB.ChargesInfoID
	LEFT JOIN
		' + @DBName + '.dbo.AddressFreightInfo AFI
	ON
		AFI.AddressID=AB.ID
	WHERE
		Name='''+@CustomerName+'''
	AND
		AB.Active=''True''
'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END



--BEGIN
--	SET @SQLString = N'SELECT Name,OriCustName FROM ' + @DBName + '.dbo.AddressBook
--					WHERE Name='''+@CustomerName+''' AND BranchName='''+@BranchName+''' AND Active=''TRUE'''
--
--EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString
--
--END


=============================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


ALTER PROC [dbo].[DeliverReceipt_CustCheck_Report]
(
	@MRNo INT
	,@Fixed VARCHAR(50)
	,@BranchName VARCHAR(50)
)

AS
DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotCh DECIMAL(18,2)
SET @SQLString=N'(SELECT @TotCh=SUM((DS.ActualWeight*DS.Freight)+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage
					+(DS.ActualWeight*DS.Freight)*(DS.ServiceTax))
				FROM ' + @DBName + '.dbo.DeliverySlip DS WHERE DS.MRNo='+CONVERT(VARCHAR(10),@MRNo)+' AND DS.Active=''True''
				AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotCh INTEGER OUTPUT', @TotCh OUTPUT

BEGIN
	SET @SQLString=N'IF('''+@Fixed+'''!=''Fixed'')
		BEGIN
			SELECT
					LCD.LRNo
					,CONVERT(VARCHAR(10),LCD.LRDate,103) as LRDate
					,LCD.NoofPackages
					,DS.ActualWeight as Weight
					,LCD.Contents
					,DS.MRNo
					,CONVERT(VARCHAR(10),DS.DeliveryDate,103) as DeliveryDate
					,UPPER(DS.CustomerName) as CustomerName
					,DS.Packing
					,DS.PrivateMarks
					,CAST((DS.ActualWeight * DS.Freight)as Decimal(18,2)) as Freight
					,DS.Labour
					,DS.DeliveryCh
					,DS.StationaryCh
					,DS.Demurrage
					,DS.LocalCartage
					,CAST(((DS.ActualWeight * DS.Freight) * (DS.ServiceTax))as Decimal(18,2)) as ServiceTax
					,'''+CONVERT(VARCHAR(10),@TotCh)+''' as Total
			--		,SUM(DS.Freight+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage+DS.ServiceTax)
				FROM
					' + @DBName + '.dbo.DeliverySlip DS
				JOIN
					' + @DBName + '.dbo.LorryChallanDescription LCD
				ON
					DS.LorryChallanDescID=LCD.ID
				WHERE
					MRNo='''+CONVERT(VARCHAR(10),@MRNo)+'''
				AND
					LCD.Active=''True''
				AND
					DS.Active=''True''
		END
		ELSE
				SELECT
					LCD.LRNo
					,CONVERT(VARCHAR(10),LCD.LRDate,103) as LRDate
					,LCD.NoofPackages
					,CAST(''Fixed'' as VARCHAR(10)) as Weight
					,LCD.Contents
					,DS.MRNo
					,CONVERT(VARCHAR(10),DS.DeliveryDate,103) as DeliveryDate
					,UPPER(DS.CustomerName) as CustomerName
					,DS.Packing
					,DS.PrivateMarks
					,CAST((DS.ActualWeight * DS.Freight)as Decimal(18,2)) as Freight
					,DS.Labour
					,DS.DeliveryCh
					,DS.StationaryCh
					,DS.Demurrage
					,DS.LocalCartage
					,CAST(((DS.ActualWeight * DS.Freight) * (DS.ServiceTax))as Decimal(18,2)) as ServiceTax
					,'''+CONVERT(VARCHAR(10),@TotCh)+''' as Total
			--		,SUM(DS.Freight+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage+DS.ServiceTax)
				FROM
					' + @DBName + '.dbo.DeliverySlip DS
				JOIN
					' + @DBName + '.dbo.LorryChallanDescription LCD
				ON
					DS.LorryChallanDescID=LCD.ID
				WHERE
					MRNo='''+CONVERT(VARCHAR(10),@MRNo)+'''
				AND
					LCD.Active=''True''
				AND
					DS.Active=''True''
	'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

=====================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go












/*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 18-2-2012
		DESCRIPTION : Report for Delivery Slip OR Delivery Reciept
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/

ALTER PROC [dbo].[DeliverReceipt_Report]
(
	@MRNo INT
	,@Fixed VARCHAR(50)
	,@BranchName VARCHAR(50)
)

AS
DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotCh DECIMAL(18,2)
SET @SQLString=N'(SELECT @TotCh=SUM((DS.ActualWeight*DS.Freight)+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage
					+(DS.ActualWeight*DS.Freight)*(DS.ServiceTax))
				FROM ' + @DBName + '.dbo.DeliverySlip DS WHERE DS.MRNo='+CONVERT(VARCHAR(10),@MRNo)+' AND DS.Active=''True''
				AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotCh INTEGER OUTPUT', @TotCh OUTPUT

BEGIN
	SET @SQLString=N'IF('''+@Fixed+'''!=''Fixed'')
		BEGIN
			 SELECT
				LCD.LRNo
				,CONVERT(VARCHAR(10),LCD.LRDate,103) as LRDate
				,LCD.NoofPackages
				,DS.ActualWeight as Weight
				,LCD.Contents
				,DS.MRNo
				,CONVERT(VARCHAR(10),DS.DeliveryDate,103) as DeliveryDate
				,UPPER(DS.OriCustName) as CustomerName
				,DS.Packing
				,DS.PrivateMarks
				,CAST((DS.ActualWeight * DS.Freight)as Decimal(18,2)) as Freight
				,DS.Labour
				,DS.DeliveryCh
				,DS.StationaryCh
				,DS.Demurrage
				,DS.LocalCartage
				,CAST(((DS.ActualWeight * DS.Freight) * (DS.ServiceTax))as Decimal(18,2)) as ServiceTax
				,'''+CONVERT(VARCHAR(10),@TotCh)+''' as Total
		--		,SUM(DS.Freight+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage+DS.ServiceTax)
			FROM
				' + @DBName + '.dbo.DeliverySlip DS
			JOIN
				' + @DBName + '.dbo.LorryChallanDescription LCD
			ON
				DS.LorryChallanDescID=LCD.ID
			WHERE
				MRNo='''+CONVERT(VARCHAR(10),@MRNo)+'''
			AND
				LCD.Active=''True''
			AND
				DS.Active=''True''
		END
		ELSE
			SELECT
				LCD.LRNo
				,CONVERT(VARCHAR(10),LCD.LRDate,103) as LRDate
				,LCD.NoofPackages
				,CAST(''FIXED'' as VARCHAR(10)) as Weight
				,LCD.Contents
				,DS.MRNo
				,CONVERT(VARCHAR(10),DS.DeliveryDate,103) as DeliveryDate
				,UPPER(DS.OriCustName) as CustomerName
				,DS.Packing
				,DS.PrivateMarks
				,CAST((DS.ActualWeight * DS.Freight)as Decimal(18,2)) as Freight
				,DS.Labour
				,DS.DeliveryCh
				,DS.StationaryCh
				,DS.Demurrage
				,DS.LocalCartage
				,CAST(((DS.ActualWeight * DS.Freight) * (DS.ServiceTax))as Decimal(18,2)) as ServiceTax
				,'''+CONVERT(VARCHAR(10),@TotCh)+''' as Total
		--		,SUM(DS.Freight+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage+DS.ServiceTax)
			FROM
				' + @DBName + '.dbo.DeliverySlip DS
			JOIN
				' + @DBName + '.dbo.LorryChallanDescription LCD
			ON
				DS.LorryChallanDescID=LCD.ID
			WHERE
				MRNo='''+CONVERT(VARCHAR(10),@MRNo)+'''
			AND
				LCD.Active=''True''
			AND
				DS.Active=''True''
			'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

============================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go




ALTER PROC [dbo].[DeliverReceipt_CustCheck_Report]
(
	@MRNo INT
	,@Fixed VARCHAR(50)
	,@BranchName VARCHAR(50)
)

AS
DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotCh DECIMAL(18,2)
SET @SQLString=N'(SELECT @TotCh=SUM((DS.ActualWeight*DS.Freight)+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage
					+(DS.ActualWeight*DS.Freight)*(DS.ServiceTax))
				FROM ' + @DBName + '.dbo.DeliverySlip DS WHERE DS.MRNo='+CONVERT(VARCHAR(10),@MRNo)+' AND DS.Active=''True''
				AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotCh INTEGER OUTPUT', @TotCh OUTPUT

BEGIN
	SET @SQLString=N'IF('''+@Fixed+'''!=''Fixed'')
		BEGIN
			SELECT
					LCD.LRNo
					,CONVERT(VARCHAR(10),LCD.LRDate,103) as LRDate
					,LCD.NoofPackages
					,DS.ActualWeight as Weight
					,LCD.Contents
					,DS.MRNo
					,CONVERT(VARCHAR(10),DS.DeliveryDate,103) as DeliveryDate
					,UPPER(DS.CustomerName) as CustomerName
					,DS.Packing
					,DS.PrivateMarks
					,CAST((DS.ActualWeight * DS.Freight)as Decimal(18,2)) as Freight
					,DS.Labour
					,DS.DeliveryCh
					,DS.StationaryCh
					,DS.Demurrage
					,DS.LocalCartage
					,CAST(((DS.ActualWeight * DS.Freight) * (DS.ServiceTax))as Decimal(18,2)) as ServiceTax
					,'''+CONVERT(VARCHAR(10),@TotCh)+''' as Total
			--		,SUM(DS.Freight+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage+DS.ServiceTax)
				FROM
					' + @DBName + '.dbo.DeliverySlip DS
				JOIN
					' + @DBName + '.dbo.LorryChallanDescription LCD
				ON
					DS.LorryChallanDescID=LCD.ID
				WHERE
					MRNo='''+CONVERT(VARCHAR(10),@MRNo)+'''
				AND
					LCD.Active=''True''
				AND
					DS.Active=''True''
		END
		ELSE
				SELECT
					LCD.LRNo
					,CONVERT(VARCHAR(10),LCD.LRDate,103) as LRDate
					,LCD.NoofPackages
					,CAST(''FIXED'' as VARCHAR(10)) as Weight
					,LCD.Contents
					,DS.MRNo
					,CONVERT(VARCHAR(10),DS.DeliveryDate,103) as DeliveryDate
					,UPPER(DS.CustomerName) as CustomerName
					,DS.Packing
					,DS.PrivateMarks
					,CAST((DS.ActualWeight * DS.Freight)as Decimal(18,2)) as Freight
					,DS.Labour
					,DS.DeliveryCh
					,DS.StationaryCh
					,DS.Demurrage
					,DS.LocalCartage
					,CAST(((DS.ActualWeight * DS.Freight) * (DS.ServiceTax))as Decimal(18,2)) as ServiceTax
					,'''+CONVERT(VARCHAR(10),@TotCh)+''' as Total
			--		,SUM(DS.Freight+DS.Labour+DS.DeliveryCh+DS.StationaryCh+DS.Demurrage+DS.LocalCartage+DS.ServiceTax)
				FROM
					' + @DBName + '.dbo.DeliverySlip DS
				JOIN
					' + @DBName + '.dbo.LorryChallanDescription LCD
				ON
					DS.LorryChallanDescID=LCD.ID
				WHERE
					MRNo='''+CONVERT(VARCHAR(10),@MRNo)+'''
				AND
					LCD.Active=''True''
				AND
					DS.Active=''True''
	'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

===================================================================================================================================================


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


















   /*===========================================================
		CREATED BY : Balakumaran N
		CREATED DATE : 20-01-2012
		DESCRIPTION : To Insert the record to the Delivery Slip table AND Update the record to the InvoiceBalance, TotalBalance And Payments Table
		UPDATED BY : 
		UPDATED DATE :
    ============================================================*/


ALTER PROC [dbo].[DeliverySlip_I]
(
	@LRNO			VARCHAR(25)
	,@MRNO			VARCHAR(25)
	,@Packing		VARCHAR(25)
	,@hID			INT
	,@DeliveryDate	DATETIME
	,@ActWeight		DECIMAL(18,2)
	,@CustomerName	VARCHAR(30)
	,@OriCustName	VARCHAR(30)
	,@PrivateMarks	VARCHAR(150)
	,@Freight		DECIMAL(18,2)
	,@Labour		DECIMAL(18,2)
	,@DeliveryCh	DECIMAL(18,2)
	,@StationaryCh	DECIMAL(18,2)
	,@Demurrage		DECIMAL(18,2)
	,@LocalCartage	DECIMAL(18,2)
	,@ServiceTax	DECIMAL(18,2)
	,@BranchName	VARCHAR(50)
	,@UserID		VARCHAR(25)
)

AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @InvBalID INT
DECLARE @DeliverySlipID INT
DECLARE @ToPay DECIMAL(18,2)
DECLARE @Amount DECIMAL(18,2)
DECLARE @TotFreight DECIMAL(18,2)
DECLARE @TotService DECIMAL(18,2)
DECLARE @Balance DECIMAL(18,2)
DECLARE @ContactID INt
DECLARE @TimeDate as datetime
DECLARE @Time datetime

	SET @Time=(SELECT
	CONVERT(VARCHAR(8),GETDATE(),108) AS ForTime)      
	SET @TimeDate=@DeliveryDate+@Time

BEGIN

SET @TotFreight=(SELECT (@ActWeight * @Freight))

SET @TotService=(SELECT (@ActWeight * @Freight) * @ServiceTax)

SET @Amount=(SELECT (@TotFreight+@Labour+@DeliveryCh+@StationaryCh	+@Demurrage	+@LocalCartage	+@TotService) as Total)



	SET @SQLString = N'IF NOT EXISTS(SELECT * FROM '+@DBName+'.dbo.DeliverySlip WHERE MRNO='+CONVERT(VARCHAR(10),@MRNO)+'
						 AND BranchName='''+@BranchName+''' AND Active=''True'')
	BEGIN
		INSERT INTO '+@DBName+'.dbo.DeliverySlip
			(
				MRNO
				,LorryChallanDescID
				,CustomerName
				,OriCustName
				,DeliveryDate
				,ActualWeight
				,Packing
				,PrivateMarks
				,Freight
				,Labour
				,DeliveryCh
				,StationaryCh
				,Demurrage
				,LocalCartage
				,ServiceTax
				,Amount
				,Balance
				,BranchName
				,Active
				,PaymentStatus
				,CreatedBy
				,CreatedDate
			)
		VALUES
			(
				'''+CONVERT(VARCHAR(10),@MRNO)+'''
				,'''+CONVERT(VARCHAR(10),@hID)+'''
				,'''+@CustomerName+'''
				,'''+@OriCustName+'''
				,'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
				,'''+CONVERT(VARCHAR(10),@ActWeight)+'''
				,'''+@Packing+'''
				,'''+@PrivateMarks+'''
				,'''+CONVERT(VARCHAR(10),@Freight)+'''
				,'''+CONVERT(VARCHAR(10),@Labour)+'''
				,'''+CONVERT(VARCHAR(10),@DeliveryCh)+'''
				,'''+CONVERT(VARCHAR(10),@StationaryCh)+'''
				,'''+CONVERT(VARCHAR(10),@Demurrage)+'''
				,'''+CONVERT(VARCHAR(10),@LocalCartage)+'''
				,'''+CONVERT(VARCHAR(10),@ServiceTax)+'''
				,'''+CONVERT(VARCHAR(10),@Amount)+'''
				,'''+CONVERT(VARCHAR(10),@Amount)+'''
				,'''+@BranchName+'''
				,''True''
				,''True''
				,'''+@UserID+'''
				,'''+@GETDATE+'''
			)
		SELECT @DeliverySlipID = SCOPE_IDENTITY()
	END'

		EXEC sp_executesql @SQLString,N'@DeliverySlipID INTEGER OUTPUT', @DeliverySlipID OUTPUT
 
	SET @SQLString=N'(SELECT @ToPay=(Freight + Labour + DeliveryCh + StationaryCh + Demurrage + LocalCartage + ServiceTax) 
					FROM '+@DBName+'.dbo.DeliverySlip WHERE LorryChallanDescID='+CONVERT(VARCHAR(10),@hID)+'
					 AND BranchName='''+@BranchName+''' AND ACTIVE=''TRUE'')'
	
	EXEC sp_executesql @SQLString,N'@ToPay INTEGER OUTPUT', @ToPay OUTPUT
	
	SET @SQLString=N'UPDATE 
		 '+@DBName+'_Acc.dbo.Company_EntryItemCount
	SET
		ItemCount=ISNULL(ItemCount,0)+1'

	EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString
	
	DECLARE @EntryITCount INT
	DECLARE @AccID INT
	DECLARE @AccOriCustID INT
	DECLARE @AccOthersID INT
	DECLARE @AccParcelID INT
	DECLARE @RelAcc VARCHAR(20)

	SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount)'

	EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT

	SET @SQLString=N'(SELECT @AccID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+'''
						AND BranchName='''+@BranchName+''' AND Status=''True'')'

	EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT

	SET @SQLString=N'(SELECT @AccOriCustID=ID FROM '+@DBName+'_Acc.dbo.Accounts WHERE [Name]='''+@OriCustName+'''
						AND BranchName='''+@BranchName+''' AND Status=''True'')'

	EXEC sp_executesql @SQLString,N'@AccOriCustID INTEGER OUTPUT', @AccOriCustID OUTPUT

	SET @SQLString=N'(SELECT @ContactID=ID FROM '+@DBName+'.dbo.AddressBook WHERE [Name]='''+@CustomerName+'''
						 AND BranchName='''+@BranchName+''' AND Active=''True'')'

	EXEC sp_executesql @SQLString,N'@ContactID INTEGER OUTPUT', @ContactID OUTPUT

	SET @SQLString=N'IF NOT EXISTS(SELECT * FROM '+@DBName+'_Acc.dbo.DebitsCredits 
					WHERE Particular=''MRNo'' + '' '' +  ''' + CONVERT(VARCHAR(10),@MRNo)+'''
					AND BranchName='''+@BranchName+''' AND Status=''True'')
	BEGIN
		IF('''+@CustomerName+'''=''Cash'')
		BEGIN
			INSERT INTO '+@DBName+'_Acc.dbo.DebitsCredits
				(
					Date
					,AccountID
					,AccOriCustID
					,DeliveryID
					,Amount
					,BranchName
					,CreatedAt
					,CreatedBy
					,Type
					,Status
					,Particular
					,RelationAccount
				)
			   VALUES
				(
					'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
					,'''+CONVERT(VARCHAR(10),@AccID)+'''
					,'''+CONVERT(VARCHAR(10),@AccOriCustID)+'''
					,'''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
					,'''+CONVERT(VARCHAR(10),@Amount)+'''
					,'''+@BranchName+'''
					,'''+@GETDATE+'''
					,'''+@UserID+'''
					,''Cr''
					,1
					,''MRNo'' + '' '' + '''+CONVERT(VARCHAR(10),@MRNo)+'''
					,'''+CONVERT(VARCHAR(10),@AccID)+'''
				)
		END
		ELSE
		BEGIN
			INSERT INTO '+@DBName+'_Acc.dbo.DebitsCredits
				(
					Date
					,AccountID
					,AccOriCustID
					,DeliveryID
					,Amount
					,BranchName
					,CreatedAt
					,CreatedBy
					,Type
					,Status
					,Particular
					,RelationAccount
				)
			VALUES
				(
					'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
					,'''+CONVERT(VARCHAR(10),@AccID)+'''
					,'''+CONVERT(VARCHAR(10),@AccOriCustID)+'''
					,'''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
					,'''+CONVERT(VARCHAR(10),@Amount)+'''
					,'''+@BranchName+'''
					,'''+@GETDATE+'''
					,'''+@UserID+'''
					,''Dr''
					,1
					,''MRNo'' + '' '' + '''+CONVERT(VARCHAR(10),@MRNo)+'''
					,'''+@CustomerName+'''
				)
		END

		INSERT INTO DailyBalance
		(
			ContactID
			,DeliveryID
			,Date
			,Balance
			,TotBalance
			,BranchName
			,Active
			,CreatedBy
			,CreatedDate
		)
		VALUES
		(
			'''+CONVERT(VARCHAR(10),@ContactID)+''',
			'''+CONVERT(VARCHAR(10),@DeliverySlipID)+''',
			'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+''',
			'''+CONVERT(VARCHAR(10),@Amount)+''',
			'''+CONVERT(VARCHAR(10),@Amount)+''',
			'''+@BranchName+''',
			''True'',
			'''+@UserID+''',
			'''+@GETDATE+'''
		)		
--	UPDATE 
--			AutoGeneration
--		SET
--			DeliverySlip_MRNo=@MRNO;

	UPDATE
			'+@DBName+'.dbo.LorryChallanDescription
		SET
			ToPay='''+CONVERT(VARCHAR(10),@Amount)+'''
			,CustName='''+@CustomerName+'''
			,OriCustName='''+@OriCustName+'''
	WHERE
		LRNo='''+CONVERT(VARCHAR(10),@LRNO)+'''
	AND
		BranchName='''+@BranchName+'''
	AND
		Active=''True''
	END'
END

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

=================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go











ALTER PROC [dbo].[DeliverySlip_U]
(
	@LRNO				VARCHAR(25)
	,@MRNO				VARCHAR(25)
	,@DeliverySlipID	INT
	,@ActWeight			DECIMAL(18,2)
	,@Packing			VARCHAR(25)	
	,@PrivateMarks		VARCHAR(150)	
	,@Freight			DECIMAL(18,2)
	,@Labour			DECIMAL(18,2)		
	,@DeliveryCh		DECIMAL(18,2)		
	,@StationaryCh		DECIMAL(18,2)		
	,@Demurrage			DECIMAL(18,2)		
	,@LocalCartage		DECIMAL(18,2)		
	,@ServiceTax		DECIMAL(18,2)		
	,@DeliveryDate		DATETIME
	,@CustomerName		VARCHAR(30)
	,@OriCustName		VARCHAR(30)
	,@BranchName		VARCHAR(50)
	,@UserID			VARCHAR(25)
)

AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @LorryDescID INT
DECLARE @LDescID INT
DECLARE @ToPay DECIMAL
DECLARE @Amount DECIMAL
DECLARE @TotFreight DECIMAL(18,2)
DECLARE @TotService DECIMAL(18,2)
DECLARE @Amt DECIMAL
DECLARE @ContactID INT
DECLARE @OldAmt DECIMAL
DECLARE @TotalBalance DECIMAL
DECLARE @Total DECIMAL(18,2)
DECLARE @CName VARCHAR(25)

SET @SQLString=N'(SELECT @CName=CustomerName FROM '+@DBName+'.dbo.DeliverySlip WHERE ID='+CONVERT(VARCHAR(10),@DeliverySlipID)+'
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@CName VARCHAR(20) OUTPUT', @CName OUTPUT

SET @SQLString=N'(SELECT @LorryDescID=LorryChallanDescID FROM '+@DBName+'.dbo.DeliverySlip WHERE ID='+CONVERT(VARCHAR(10),@DeliverySlipID)+'
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@LorryDescID INTEGER OUTPUT', @LorryDescID OUTPUT

SET @SQLString=N'(SELECT @LDescID=ID FROM '+@DBName+'.dbo.LorryChallanDescription WHERE LRNo='+CONVERT(VARCHAR(10),@LRNo)+'
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@LDescID INTEGER OUTPUT', @LDescID OUTPUT

SET @TotFreight=(SELECT (@ActWeight * @Freight))

SET @TotService=(SELECT (@ActWeight * @Freight) * @ServiceTax)

SET @Amount=(SELECT (@TotFreight + @Labour + @DeliveryCh + @StationaryCh +@Demurrage + @LocalCartage + @TotService) )

SET @SQLString=N'(SELECT @ContactID=ID FROM '+@DBName+'.dbo.AddressBook WHERE [Name]='''+@CustomerName+'''
					 AND BranchName='''+@BranchName+''' AND Active=''True'')'

EXEC sp_executesql @SQLString,N'@ContactID INTEGER OUTPUT', @ContactID OUTPUT

SET @SQLString=N'(SELECT @ToPay=(Freight + Labour + DeliveryCh + StationaryCh + Demurrage + LocalCartage + ServiceTax) 
					FROM ' + @DBName + '.dbo.DeliverySlip WHERE ID='+CONVERT(VARCHAR(10),@DeliverySlipID)+' 
					AND BranchName='''+@BranchName+''' AND ACTIVE=''True'')'

EXEC sp_executesql @SQLString,N'@ToPay INTEGER OUTPUT', @ToPay OUTPUT

DECLARE @AccID INT
	
SET @SQLString=N'(SELECT @AccID=ID FROM ' + @DBName + '_Acc.dbo.Accounts WHERE [Name]='''+@CustomerName+'''
					 AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@AccID INTEGER OUTPUT', @AccID OUTPUT

DECLARE @AccOriCustID INT
	
SET @SQLString=N'(SELECT @AccOriCustID=ID FROM ' + @DBName + '_Acc.dbo.Accounts WHERE [Name]='''+@OriCustName+'''
					 AND BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@AccOriCustID INTEGER OUTPUT', @AccOriCustID OUTPUT

DECLARE @EntryITCount INT

SET @SQLString=N'(SELECT @EntryITCount=ItemCount FROM '+@DBName+'_Acc.dbo.Company_EntryItemCount)'

EXEC sp_executesql @SQLString,N'@EntryITCount INTEGER OUTPUT', @EntryITCount OUTPUT

DECLARE @TimeDate as datetime
	DECLARE @Time datetime
	SET @Time=(SELECT
	CONVERT(VARCHAR(8),GETDATE(),108) AS ForTime)      
	SET @TimeDate=@DeliveryDate+@Time

BEGIN
	SET @SQLString=N'IF NOT EXISTS(SELECT * FROM '+@DBName+'.dbo.Payments WHERE MRNO='''+@MRNO+''' 
					AND BranchName='''+@BranchName+''' AND Active=''True'')
	BEGIN
		UPDATE
			' + @DBName +'.dbo.DeliverySlip
		SET
			MRNO='''+CONVERT(VARCHAR(20),@MRNO)+'''
			,LorryChallanDescID='''+CONVERT(VARCHAR(10),@LDescID)+'''
			,CustomerName='''+@CustomerName+'''
			,OriCustName='''+@OriCustName+'''
			,ActualWeight='''+CONVERT(VARCHAR(10),@ActWeight)+'''
			,Packing='''+@Packing+'''
			,PrivateMarks='''+@PrivateMarks+'''
			,Freight='''+CONVERT(VARCHAR(10),@Freight)+'''
			,Labour='''+CONVERT(VARCHAR(10),@Labour)+'''
			,DeliveryCh='''+CONVERT(VARCHAR(10),@DeliveryCh)+'''
			,StationaryCh='''+CONVERT(VARCHAR(10),@StationaryCh)+'''
			,Demurrage='''+CONVERT(VARCHAR(10),@Demurrage)+'''
			,LocalCartage='''+CONVERT(VARCHAR(10),@LocalCartage)+'''
			,ServiceTax='''+CONVERT(VARCHAR(10),@ServiceTax)+'''
			,DeliveryDate='''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
			,Amount='''+CONVERT(VARCHAR(10),@Amount)+'''
			,Balance='''+CONVERT(VARCHAR(10),@Amount)+'''
			,PaymentStatus=''True''
			,BranchName='''+@BranchName+'''
			,UpdatedBy='''+@UserID+'''
			,UpdatedDate='''+@GETDATE+'''
		WHERE
			ID='''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
		AND
			Active=''True''
	END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString	


	SET @SQLString=N'IF NOT EXISTS(SELECT * FROM '+@DBName+'.dbo.Payments WHERE MRNO='''+@MRNO+''' 
					AND BranchName='''+@BranchName+''' AND Active=''True'')
		BEGIN

		IF('''+CONVERT(VARCHAR(10),@LDescID)+'''='''+CONVERT(VARCHAR(10),@LorryDescID)+''')
			BEGIN

				UPDATE
						' + @DBName + '.dbo.LorryChallanDescription
				SET
						ToPay='''+CONVERT(VARCHAR(10),@Amount)+'''
						,CustName='''+@CustomerName+'''
						,OriCustName='''+@OriCustName+'''
				WHERE
						ID='''+CONVERT(VARCHAR(10),@LorryDescID)+'''
				AND 
						BranchName='''+@BranchName+'''
				AND
						Active=''True''
			END
		ELSE
			BEGIN
				UPDATE
					' + @DBName + '.dbo.LorryChallanDescription
				SET
					ToPay='''+CONVERT(VARCHAR(10),@Amount)+'''
					,CustName='''+@CustomerName+'''
					,OriCustName='''+@OriCustName+'''
				WHERE
					LRNo='''+@LRNO+'''
				AND 
					BranchName='''+@BranchName+'''
				AND
					Active=''True''
				
				UPDATE
						' + @DBName + '.dbo.LorryChallanDescription
				SET
						ToPay=0
				WHERE
						ID='''+CONVERT(VARCHAR(10),@LorryDescID)+'''
				AND 
						BranchName='''+@BranchName+'''
				AND
						Active=''True''
			END

		IF('''+@CName+'''!=''Cancelled'')
				BEGIN
					
					UPDATE 
							' + @DBName + '_Acc.dbo.DebitsCredits
					SET
							Amount='''+CONVERT(VARCHAR(10),@Amount)+''',
							AccountID='''+CONVERT(VARCHAR(10),@AccID)+''',
							AccOriCustID='''+CONVERT(VARCHAR(10),@AccOriCustID)+''',
							Date='''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+''',
							ModifyAt='''+@GETDATE+''',
							ModifyBY='''+@UserID+''',
							RelationAccount='''+@CustomerName+'''
					
					WHERE
							DeliveryID='''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''


					UPDATE 
						' + @DBName + '.dbo.DailyBalance
					SET
						ContactID='''+CONVERT(VARCHAR(10),@ContactID)+''',
						Date='''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+''',
						Balance='''+CONVERT(VARCHAR(10),@Amount)+''',
						TotBalance='''+CONVERT(VARCHAR(10),@Amount)+''',
						UpdatedBy='''+@UserID+''',
						UpdatedDate='''+@GETDATE+'''
					WHERE
						DeliveryId='''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
					AND 
						BranchName='''+@BranchName+'''
					AND
						Active=''True''

				END
		ELSE
		   BEGIN

				UPDATE 
					' + @DBName + '_Acc.dbo.Company_EntryItemCount
				SET
					ItemCount=ItemCount+1

			IF('''+@CustomerName+'''=''Cash'')
				BEGIN

					INSERT INTO ' + @DBName + '_Acc.dbo.DebitsCredits
						(
							Date
							,AccountID
							,AccOriCustID
							,DeliveryID
							,Amount
							,BranchName
							,CreatedAt
							,CreatedBy
							,Type
							,Status
							,Particular
							,RelationAccount
						)
					   VALUES
						(
							'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
							,'''+CONVERT(VARCHAR(10),@AccID)+'''
							,'''+CONVERT(VARCHAR(10),@AccOriCustID)+'''
							,'''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
							,'''+CONVERT(VARCHAR(10),@Amount)+'''
							,'''+@BranchName+'''
							,'''+@GETDATE+'''
							,'''+@UserID+'''
							,''Cr''
							,1
							,''MRNo'' + '' '' + ''' + CONVERT(VARCHAR(20),@MRNo) + '''
							,'''+@CustomerName+'''
						)

					END
				ELSE
					BEGIN
						INSERT INTO ' + @DBName + '_Acc.dbo.DebitsCredits
							(
								Date
								,AccountID
								,AccOriCustID
								,DeliveryID
								,Amount
								,BranchName
								,CreatedAt
								,CreatedBy
								,Type
								,Status
								,Particular
								,RelationAccount
							)
						VALUES
							(
								'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+'''
								,'''+CONVERT(VARCHAR(10),@AccID)+'''
								,'''+CONVERT(VARCHAR(10),@AccOriCustID)+'''
								,'''+CONVERT(VARCHAR(10),@DeliverySlipID)+'''
								,'''+CONVERT(VARCHAR(10),@Amount)+'''
								,'''+@BranchName+'''
								,'''+@GETDATE+'''
								,'''+@UserID+'''
								,''Dr''
								,1
								,''MRNo'' + '' '' + ''' + CONVERT(VARCHAR(20),@MRNo) +'''
								,'''+@CustomerName+'''
							)
					END
		
	 

			INSERT INTO ' + @DBName + '.dbo.DailyBalance
				(
					ContactID
					,DeliveryID
					,Date
					,Balance
					,TotBalance
					,BranchName
					,Active
					,CreatedBy
					,CreatedDate
				)
				VALUES
				(
					'''+CONVERT(VARCHAR(10),@ContactID)+''',
					'''+CONVERT(VARCHAR(10),@DeliverySlipID)+''',
					'''+Convert(varchar(10),@DeliveryDate,101)+''' + '' '' + '''+CONVERT(VARCHAR(10),GetDate(),108)+''',
					'''+CONVERT(VARCHAR(10),@Amount)+''',
					'''+CONVERT(VARCHAR(10),@Amount)+''',
					'''+@BranchName+''',
					''True'',
					'''+@UserID+''',
					'''+@GETDATE+'''
				)
			END	
	END'


EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString	

END

=====================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go

ALTER PROC [dbo].[DailyPayment_Report]
(
@TDate DATETIME
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotalAmt DECIMAL(18,2)

SET @SQLString=N'(SELECT @TotalAmt=SUM(P.Amount) FROM '+@DBName+'.dbo.Payments P
				  JOIN '+@DBName+'.dbo.AddressBook AB ON P.ContactID=AB.ID WHERE
				  CONVERT(VARCHAR(15),P.PaidDate,103)='''+CONVERT(VARCHAR(15),@TDate,103)+'''
				  AND P.Active=''True'' AND	AB.Active=''True'' AND P.BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotalAmt INTEGER OUTPUT', @TotalAmt OUTPUT

SET @SQLString=N'BEGIN SELECT
		AB.Name as Name
		,CONVERT(VARCHAR(10),PaidDate,103) as Date
		,SUM(Amount) as Amount
		,'''+CONVERT(VARCHAR(10),@TotalAmt)+''' as TotalAmt
	FROM
		'+@DBName+'.dbo.Payments P
	JOIN
		'+@DBName+'.dbo.AddressBook AB
	ON
		P.ContactID=AB.ID
	WHERE
		CONVERT(VARCHAR(15),P.PaidDate,103)='''+CONVERT(VARCHAR(15),@TDate,103)+'''
	AND
		P.Active=''True''
	AND
		AB.Active=''True''
	AND
		P.BranchName='''+@BranchName+'''
		
		GROUP BY Name,PaidDate
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

==========================================================================================================================================================

ALTER PROC DailyPayment_Load_ColBy
(
@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'


SET @SQLString=N'BEGIN SELECT
						 ID
						 ,EmpName
					   FROM
						 '+@DBName+'.dbo.Employee
						WHERE
						 Active=''True''
						AND
						 BranchName='''+@BranchName+'''
				 END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString


===============================================================================================================================

ALTER PROC [dbo].[DailyPayment_ColBy_Report]
(
@TDate DATETIME
,@FDate DATETIME
,@EID INT
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotalAmt DECIMAL(18,2)

SET @SQLString=N'(SELECT @TotalAmt=SUM(P.Amount) FROM '+@DBName+'.dbo.Payments P
				  JOIN '+@DBName+'.dbo.AddressBook AB ON P.ContactID=AB.ID JOIN Employee E ON P.EmpID=E.ID WHERE
				  P.EmpID='''+CONVERT(VARCHAR(10),@EID)+'''
					AND
		P.PaidDate BETWEEN '''+CONVERT(VARCHAR(10),@TDate,101)+''' AND '''+CONVERT(VARCHAR(10),@FDate,101)+'''
				  AND P.Active=''True'' AND	AB.Active=''True'' AND P.BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotalAmt INTEGER OUTPUT', @TotalAmt OUTPUT

SET @SQLString=N'BEGIN SELECT
		AB.Name as Name
		,CONVERT(VARCHAR(10),PaidDate,103) as Date
		,SUM(Amount) as Amount
		,'''+CONVERT(VARCHAR(10),@TotalAmt)+''' as TotalAmt
	FROM
		'+@DBName+'.dbo.Payments P
	JOIN
		'+@DBName+'.dbo.AddressBook AB
	ON
		P.ContactID=AB.ID
	JOIN
		'+@DBName+'.dbo.Employee E
	ON
		P.EmpID=E.ID
	WHERE
		P.EmpID='''+CONVERT(VARCHAR(10),@EID)+'''
	AND
		P.PaidDate BETWEEN '''+CONVERT(VARCHAR(10),@TDate,101)+''' AND '''+CONVERT(VARCHAR(10),@FDate,101)+'''
	AND
		P.Active=''True''
	AND
		AB.Active=''True''
	AND
		E.Active=''True''
	AND
		P.BranchName='''+@BranchName+'''
		
		GROUP BY Name,PaidDate
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

==========================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


ALTER PROC [dbo].[DailyPayment_ColBy_Report]
(
@FDate DATETIME
,@TDate DATETIME
,@EID INT
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotalAmt DECIMAL(18,2)

SET @SQLString=N'(SELECT @TotalAmt=SUM(P.Amount) FROM '+@DBName+'.dbo.Payments P
				  JOIN '+@DBName+'.dbo.AddressBook AB ON P.ContactID=AB.ID JOIN Employee E ON P.EmpID=E.ID WHERE
				  P.EmpID='+CONVERT(VARCHAR(10),@EID)+'
					AND
		P.PaidDate BETWEEN '''+CONVERT(VARCHAR(10),@FDate,101)+''' AND '''+CONVERT(VARCHAR(10),@TDate,101)+'''
				  AND P.Active=''True'' AND	AB.Active=''True'' AND P.BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotalAmt INTEGER OUTPUT', @TotalAmt OUTPUT

SET @SQLString=N'BEGIN SELECT
		UPPER(AB.Name) as Name
		,''Collected By - '' + UPPER(E.EmpName) as EmpName
		,''COLLECTEDBY PAYMENT REPORT'' as PaymentOption
		,'''+CONVERT(VARCHAR(10),@FDate,103)+''' as FromDate
		,'''+CONVERT(VARCHAR(10),@TDate,103)+''' as ToDate
--		,CONVERT(VARCHAR(10),PaidDate,103) as Date
		,SUM(Amount) as Amount
		,'''+CONVERT(VARCHAR(10),@TotalAmt)+''' as TotalAmt
	FROM
		'+@DBName+'.dbo.Payments P
	JOIN
		'+@DBName+'.dbo.AddressBook AB
	ON
		P.ContactID=AB.ID
	JOIN
		'+@DBName+'.dbo.Employee E
	ON
		P.EmpID=E.ID
	WHERE
		P.EmpID='+CONVERT(VARCHAR(10),@EID)+'
	AND
		P.PaidDate BETWEEN '''+CONVERT(VARCHAR(10),@FDate,101)+''' AND '''+CONVERT(VARCHAR(10),@TDate,101)+'''
	AND
		P.Active=''True''
	AND
		AB.Active=''True''
	AND
		E.Active=''True''
	AND
		P.BranchName='''+@BranchName+'''
		
		GROUP BY Name,EmpName HAVING sum(amount)>0 ORDER BY Name ASC
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

==================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go

ALTER PROC [dbo].[DailyPayment_DayWise_Report]
(
@TDate DATETIME
,@EID INT
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotalAmt DECIMAL(18,2)

SET @SQLString=N'(SELECT @TotalAmt=SUM(P.Amount) FROM '+@DBName+'.dbo.Payments P
				  JOIN '+@DBName+'.dbo.AddressBook AB ON P.ContactID=AB.ID JOIN Employee E ON P.EmpID=E.ID WHERE
				  P.EmpID='+CONVERT(VARCHAR(10),@EID)+'
					AND	CONVERT(VARCHAR(15),P.PaidDate,103) = '''+CONVERT(VARCHAR(10),@TDate,103)+'''
				  AND P.Active=''True'' AND	AB.Active=''True'' AND P.BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotalAmt INTEGER OUTPUT', @TotalAmt OUTPUT

SET @SQLString=N'BEGIN SELECT
		UPPER(AB.Name) as Name
		,''Collected By - '' + UPPER(E.EmpName) as EmpName
		,''COLLECTEDBY DAYWISE PAYMENT REPORT'' as PaymentOption
		,CONVERT(VARCHAR(10),PaidDate,103) as Date
		,SUM(Amount) as Amount
		,'''+CONVERT(VARCHAR(10),@TotalAmt)+''' as TotalAmt
	FROM
		'+@DBName+'.dbo.Payments P
	JOIN
		'+@DBName+'.dbo.AddressBook AB
	ON
		P.ContactID=AB.ID
	JOIN
		'+@DBName+'.dbo.Employee E
	ON
		P.EmpID=E.ID
	WHERE
		P.EmpID='+CONVERT(VARCHAR(10),@EID)+'
	AND
		CONVERT(VARCHAR(15),P.PaidDate,103) = '''+CONVERT(VARCHAR(10),@TDate,103)+'''
	AND
		P.Active=''True''
	AND
		AB.Active=''True''
	AND
		E.Active=''True''
	AND
		P.BranchName='''+@BranchName+'''
		
		GROUP BY Name,EmpName,PaidDate
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

==================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go

ALTER PROC [dbo].[DailyPayment_Monthly_Report]
(
@FDate DATETIME
,@TDate DATETIME
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotalAmt DECIMAL(18,2)

SET @SQLString=N'(SELECT @TotalAmt=SUM(P.Amount) FROM '+@DBName+'.dbo.Payments P
				  JOIN '+@DBName+'.dbo.AddressBook AB ON P.ContactID=AB.ID JOIN Employee E ON P.EmpID=E.ID WHERE
				  P.PaidDate BETWEEN '''+CONVERT(VARCHAR(10),@FDate,101)+''' AND '''+CONVERT(VARCHAR(10),@TDate,101)+'''
				  AND P.Active=''True'' AND	AB.Active=''True'' AND P.BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotalAmt INTEGER OUTPUT', @TotalAmt OUTPUT

SET @SQLString=N'BEGIN SELECT
		UPPER(AB.Name) as Name
		,''MONTHLY PAYMENT REPORT'' as PaymentOption
		,'''+CONVERT(VARCHAR(10),@FDate,103)+''' as FromDate
		,'''+CONVERT(VARCHAR(10),@TDate,103)+''' as ToDate
--		,CONVERT(VARCHAR(10),PaidDate,103) as Date
		,SUM(Amount) as Amount
		,'''+CONVERT(VARCHAR(10),@TotalAmt)+''' as TotalAmt
	FROM
		'+@DBName+'.dbo.Payments P
	JOIN
		'+@DBName+'.dbo.AddressBook AB
	ON
		P.ContactID=AB.ID
	JOIN
		'+@DBName+'.dbo.Employee E
	ON
		P.EmpID=E.ID
	WHERE
		P.PaidDate BETWEEN '''+CONVERT(VARCHAR(10),@FDate,101)+''' AND '''+CONVERT(VARCHAR(10),@TDate,101)+'''
	AND
		P.Active=''True''
	AND
		AB.Active=''True''
	AND
		E.Active=''True''
	AND
		P.BranchName='''+@BranchName+'''
		
		GROUP BY Name HAVING sum(amount)>0 ORDER BY Name ASC
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

==================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


ALTER PROC [dbo].[DailyPayment_Report]
(
@TDate DATETIME
,@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

DECLARE @TotalAmt DECIMAL(18,2)

SET @SQLString=N'(SELECT @TotalAmt=SUM(P.Amount) FROM '+@DBName+'.dbo.Payments P
				  JOIN '+@DBName+'.dbo.AddressBook AB ON P.ContactID=AB.ID WHERE
				  CONVERT(VARCHAR(15),P.PaidDate,103)='''+CONVERT(VARCHAR(15),@TDate,103)+'''
				  AND P.Active=''True'' AND	AB.Active=''True'' AND P.BranchName='''+@BranchName+''')'

EXEC sp_executesql @SQLString,N'@TotalAmt INTEGER OUTPUT', @TotalAmt OUTPUT

SET @SQLString=N'BEGIN SELECT
		AB.Name as Name
		,CONVERT(VARCHAR(10),PaidDate,103) as Date
		,SUM(Amount) as Amount
		,'''+CONVERT(VARCHAR(10),@TotalAmt)+''' as TotalAmt
	FROM
		'+@DBName+'.dbo.Payments P
	JOIN
		'+@DBName+'.dbo.AddressBook AB
	ON
		P.ContactID=AB.ID
	WHERE
		CONVERT(VARCHAR(15),P.PaidDate,103)='''+CONVERT(VARCHAR(15),@TDate,103)+'''
	AND
		P.Active=''True''
	AND
		AB.Active=''True''
	AND
		P.BranchName='''+@BranchName+'''
		
		GROUP BY Name,PaidDate
	END '

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

=================================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go

ALTER PROC [dbo].[DailyPayment_Load_ColBy]
(
@BranchName VARCHAR(50)
)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'


SET @SQLString=N'BEGIN SELECT
						 ID
						 ,EmpName
					   FROM
						 '+@DBName+'.dbo.Employee
						WHERE
						 Active=''True''
						AND
						 BranchName='''+@BranchName+'''
				 END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

================================================================================================================================================



================================================================================================================================================



















































