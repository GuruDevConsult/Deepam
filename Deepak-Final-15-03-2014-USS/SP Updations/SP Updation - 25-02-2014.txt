set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go



ALTER PROCEDURE [dbo].[Authentication_I]
(
@EmployeeName		INT
,@ResourceAll	VARCHAR(1000)
,@ResourceSave	VARCHAR(1000)
,@ResourceDelete	VARCHAR(1000)
,@ResourceView	VARCHAR(1000)
,@ResourceEdit	VARCHAR(1000)
,@ResourceID VARCHAR(1000)
,@userName varchar(50)
,@BranchName VARCHAR(50)

)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
SET @SQLString = N'IF NOT EXISTS(SELECT ''*'' FROM '+@DBName+'.dbo.Authentication 
					WHERE EmployeeID ='''+ CONVERT(VARCHAR(10),@EmployeeName)+''' AND ACTIVE = ''TRUE'' )
	BEGIN
		INSERT INTO '+@DBName+'.dbo.Authentication
		(
			EmployeeID,
            ResourceID,
			[All] ,
			[Save],
			[Delete],
			[View],
			Edit,
			Active,
			CreatedBy,
			CreatedDate
		)
		VALUES
		(
			'''+CONVERT(VARCHAR(20),@EmployeeName)+''',
            '''+@ResourceID+''',
			'''+@ResourceAll+''',
			'''+@ResourceSave+''',
			'''+@ResourceDelete+''',
			'''+@ResourceView+''',
			'''+@ResourceEdit+''',
			''True'',
			'''+@userName+''',
			'''+@GETDATE+'''
		)
	END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

=======================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


ALTER PROCEDURE [dbo].[USP_GetBalanceAmountByDate]      
(      
 @STARTINGDATE DATETIME,          
 @CLOSINGDATE DATETIME,
 @BRANCHNAME VARCHAR(50)          
)        
AS  

DECLARE @DBNAME NVARCHAR(2550)

SELECT @DBNAME=(SELECT NAME
FROM SYS.DATABASES WHERE NAME=@BRANCHNAME)

DECLARE @USEANDEXECSTATMENT NVARCHAR(4000), @SQLSTRING NVARCHAR(4000)

SET @USEANDEXECSTATMENT = 'USE ' + @DBNAME +' EXEC SP_EXECUTESQL @SQLSTRING'


IF(@BRANCHNAME='Chennai')
	BEGIN
		CREATE TABLE #OLDDDSOP (NAME VARCHAR(20),TYPE VARCHAR(10),AMOUNT DECIMAL(18,2))

		INSERT INTO #OLDDDSOP(NAME,TYPE,AMOUNT)
		(
		SELECT 'OPENING BALANCE' AS NAME, 'Cr' AS TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNT FROM DEBITSCREDITS DC 
		INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID WHERE DC.DATE < CONVERT(VARCHAR(10),@STARTINGDATE,101) 
		AND A.TYPES!='Cashbook'  AND Deliveryid IS NOT NULL AND DC.STATUS='TRUE' AND DC.BRANCHNAME=@BRANCHNAME

		)

		CREATE TABLE #OLDCASHBOOK_CR (NAME VARCHAR(20),TYPE VARCHAR(10),AMOUNT1 DECIMAL(18,2))

		INSERT INTO #OLDCASHBOOK_CR(NAME,TYPE,AMOUNT1)
		(
		SELECT 'OPENING BALANCE' AS NAME,'Cr' AS TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNT1 FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE <CONVERT(VARCHAR(10),@STARTINGDATE,101) AND DC.STATUS='TRUE' AND TYPE='Cr' 
		AND TYPES='CASHBOOK' AND (GROUPID='14' OR GROUPID='30') AND DC.BRANCHNAME=@BRANCHNAME 

		)
	
		CREATE TABLE #OLDCASHBOOK_DR (NAME VARCHAR(20),TYPE VARCHAR(10),AMOUNT2 DECIMAL(18,2))

		INSERT INTO #OLDCASHBOOK_DR(NAME,TYPE,AMOUNT2)
		(
		SELECT 'OPENING BALANCE' AS NAME,'Dr' AS TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNT2 FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE <CONVERT(VARCHAR(10),@STARTINGDATE,101) AND TYPE='Dr' 
		AND TYPES='CASHBOOK' AND Deliveryid IS NULL AND DC.STATUS='TRUE' AND DC.BRANCHNAME=@BRANCHNAME 

		)	
		
		CREATE TABLE #CUSTOLDBALANCE (ACCOUNTID INT,NAME VARCHAR(50),TYPE VARCHAR(10),OLDAMOUNT DECIMAL(18,2))

		INSERT INTO #CUSTOLDBALANCE(ACCOUNTID,NAME,TYPE,OLDAMOUNT)
		(
		SELECT A.ID AS ACCOUNTID,NAME,'Dr' AS TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS OLDAMOUNT FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE <=CONVERT(VARCHAR(10),@STARTINGDATE,101)+ ' ' +CONVERT(VARCHAR(30),'23:55 PM',108)
						AND DC.STATUS='TRUE' AND TYPE='Dr' AND DC.BRANCHNAME=@BRANCHNAME AND PARTICULAR='OLDBALANCE' GROUP BY A.ID,A.NAME, DC.TYPE 

		)
		
		CREATE TABLE #DELIVERY (ACCOUNTID INT,NAME VARCHAR(50),TYPE VARCHAR(10),AMOUNT DECIMAL(18,2))

		INSERT INTO #DELIVERY(ACCOUNTID,NAME,TYPE,AMOUNT)
		(
		SELECT A.ID AS ACCOUNTID,NAME,TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNT FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE <=CONVERT(VARCHAR(10),@CLOSINGDATE,101)+ ' ' +CONVERT(VARCHAR(30),'23:55 PM',108)
						AND DC.STATUS='TRUE' AND DELIVERYID IS NOT NULL AND TYPE='Dr' AND DC.BRANCHNAME=@BRANCHNAME GROUP BY A.ID,A.NAME, DC.TYPE 

		)ORDER BY A.NAME ASC

		CREATE TABLE #PAYMENT (ACCOUNTID INT,NAME VARCHAR(50),TYPE VARCHAR(10),AMOUNT1 DECIMAL(18,2))

		INSERT INTO #PAYMENT(ACCOUNTID,NAME,TYPE,AMOUNT1)
		(
		SELECT A.ID AS ACCOUNTID, NAME,TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNT1 FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE <=CONVERT(VARCHAR(10),@CLOSINGDATE,101)+ ' ' +CONVERT(VARCHAR(30),'23:55 PM',108)
						AND DC.STATUS='TRUE' AND PAYMENTID IS NOT NULL AND DC.BRANCHNAME=@BRANCHNAME GROUP BY A.ID,A.NAME, DC.TYPE 

		)ORDER BY A.NAME ASC

		CREATE TABLE #CASHBOOKDr (ACCOUNTID INT,NAME VARCHAR(50),TYPE VARCHAR(10),AMOUNT2 DECIMAL(18,2))

		INSERT INTO #CASHBOOKDr(ACCOUNTID,NAME,TYPE,AMOUNT2)
		(
		SELECT A.ID AS ACCOUNTID,NAME,TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNT2 FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE >=CONVERT(VARCHAR(10),@STARTINGDATE,101) AND DC.Date <=CONVERT(VARCHAR(10),@CLOSINGDATE,101)+ ' ' +CONVERT(VARCHAR(30),'23:55 PM',108)
						AND DC.STATUS='TRUE' AND PAYMENTID IS NULL AND DELIVERYID IS NULL AND TYPE='Dr' AND PARTICULAR!='OLDBALANCE' AND DC.BRANCHNAME=@BRANCHNAME GROUP BY A.ID,A.NAME, DC.TYPE 

		)ORDER BY A.NAME ASC

		CREATE TABLE #DDS (AMOUNDDS DECIMAL(18,2))

		INSERT INTO #DDS(AMOUNDDS)
		(
		SELECT CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNDDS FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE >=CONVERT(VARCHAR(10),@STARTINGDATE,101) AND DC.Date <=CONVERT(VARCHAR(10),@CLOSINGDATE,101)+ ' ' +CONVERT(VARCHAR(30),'23:55 PM',108)
						AND DC.STATUS='TRUE' AND DELIVERYID IS NOT NULL AND DC.BRANCHNAME=@BRANCHNAME 

		)

		CREATE TABLE #CASHBOOKCr (ACCOUNTID INT,NAME VARCHAR(50),TYPE VARCHAR(10),AMOUNT4 DECIMAL(18,2))

		INSERT INTO #CASHBOOKCr(ACCOUNTID,NAME,TYPE,AMOUNT4)
		(
		SELECT A.ID AS ACCOUNTID,NAME,TYPE,CONVERT(INT,ROUND(ISNULL(SUM(AMOUNT),NULL),0)) AS AMOUNT2 FROM DEBITSCREDITS DC INNER JOIN CHENNAI_ACC.DBO.ACCOUNTS A ON DC.ACCOUNTID=A.ID  
		WHERE DC.DATE >=CONVERT(VARCHAR(10),@STARTINGDATE,101) AND DC.Date <=CONVERT(VARCHAR(10),@CLOSINGDATE,101)+ ' ' +CONVERT(VARCHAR(30),'23:55 PM',108)
						AND DC.STATUS='TRUE' AND PAYMENTID IS NULL AND DELIVERYID IS NULL AND TYPE='Cr' AND DC.BRANCHNAME=@BRANCHNAME GROUP BY A.ID,A.NAME, DC.TYPE 

		)ORDER BY A.NAME ASC
		
		CREATE TABLE #FINAL (ACCOUNTID INT,NAME VARCHAR(50),TYPE VARCHAR(10),AMOUNT5 DECIMAL(18,2))

		INSERT INTO #FINAL(ACCOUNTID,NAME,TYPE,AMOUNT5)
		(
		SELECT CASE WHEN ISNULL(AMOUNT2,0)>ISNULL(AMOUNT4,0) THEN A.ACCOUNTID ELSE D.ACCOUNTID END AS ACCOUNTID
		,CASE WHEN ISNULL(AMOUNT2,0)>ISNULL(AMOUNT4,0) THEN A.NAME ELSE D.NAME END AS NAME
		,CASE WHEN ISNULL(AMOUNT2,0)>ISNULL(AMOUNT4,0) THEN A.TYPE ELSE D.TYPE END AS TYPE
		,CASE WHEN ISNULL(AMOUNT2,0)>ISNULL(AMOUNT4,0) THEN ISNULL(A.AMOUNT2,0)-ISNULL(D.AMOUNT4,0) ELSE ISNULL(D.AMOUNT4,0)-ISNULL(A.AMOUNT2,0) END AS AMOUNT5 
		FROM #CASHBOOKDr A FULL JOIN #CASHBOOKCr D ON A.NAME=D.NAME
		)

		DECLARE @A VARCHAR(2000)
		

		SET @A='WITH CTE AS (SELECT ''0'' AS ACCOUNTID,OP.NAME AS NAME,CASE WHEN (ISNULL(OP.AMOUNT,0)+ISNULL(OP1.AMOUNT1,0))>ISNULL(OP2.AMOUNT2,0)
				THEN OP.TYPE ELSE OP1.TYPE END AS TYPE,CASE WHEN (ISNULL(OP.AMOUNT,0)+ISNULL(OP1.AMOUNT1,0))>ISNULL(OP2.AMOUNT2,0)
				THEN (ISNULL(OP.AMOUNT,0)+ISNULL(OP1.AMOUNT1,0))-ISNULL(OP2.AMOUNT2,0) 
				ELSE ISNULL(OP1.AMOUNT1,0)-(ISNULL(OP.AMOUNT,0)+ISNULL(Op2.AMOUNT2,0)) END AS AMOUNT 
				FROM #OLDDDSOP OP JOIN #OLDCASHBOOK_CR OP1 ON OP.NAME=OP1.NAME JOIN #OLDCASHBOOK_DR OP2 ON OP1.NAME=OP2.NAME
				UNION ALL
				SELECT A.ACCOUNTID,A.NAME,A.TYPE, CASE WHEN (ISNULL(A.AMOUNT,0)+ISNULL(OB.OLDAMOUNT,0))>(ISNULL(B.AMOUNT1,0))
				THEN ((ISNULL(A.AMOUNT,0)+ISNULL(OB.OLDAMOUNT,0))-(ISNULL(B.AMOUNT1,0)))
				ELSE ((ISNULL(B.AMOUNT1,0))-(ISNULL(A.AMOUNT,0)+ISNULL(OB.OLDAMOUNT,0))) END AS AMOUNT 
				FROM #DELIVERY A FULL JOIN #PAYMENT B ON A.NAME=B.NAME LEFT JOIN #CUSTOLDBALANCE OB ON A.NAME=OB.NAME 
				GROUP BY A.ACCOUNTID,A.NAME,A.AMOUNT,B.AMOUNT1,OB.OLDAMOUNT,A.TYPE HAVING 
				((ISNULL(A.AMOUNT,0)+ISNULL(OB.OLDAMOUNT,0))-(ISNULL(B.AMOUNT1,0)))>0 
				UNION ALL 
				SELECT C.ACCOUNTID,C.NAME,C.TYPE,C.AMOUNT5 AS AMOUNT FROM #FINAL C 
				UNION ALL 
				SELECT ''0'' AS ACCOUNTID,''DDS'' AS NAME,''Cr'' AS TYPE,SUM(D.AMOUNDDS) AS AMOUNT FROM #DDS D)
			
			SELECT ACCOUNTID,NAME,TYPE,AMOUNT FROM CTE ORDER BY CASE WHEN NAME!=''OPENING BALANCE'' THEN ''OPENING BALANCE''
			END,NAME ASC'

		EXEC(@A)
--		SELECT * FROM #DELIVERY
--		SELECT * FROM #PAYMENT
--		SELECT * FROM #CASHBOOKDr
--		SELECT * FROM #DDS
--		SELECT * FROM #CASHBOOKCr
--		SELECT * FROM #OLDDDSOP
--		SELECT * FROM #OLDCASHBOOK_CR
		DROP TABLE #OLDDDSOP
		DROP TABLE #OLDCASHBOOK_CR
		DROP TABLE #DELIVERY
		DROP TABLE #PAYMENT
		DROP TABLE #CASHBOOKDr
		DROP TABLE #DDS
		DROP TABLE #CASHBOOKCr
		DROP TABLE #FINAL
	END

=========================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go




ALTER PROCEDURE [dbo].[Authentication_I]
(
@EmployeeName		INT
,@ResourceAll	VARCHAR(1000)
,@ResourceSave	VARCHAR(1000)
,@ResourceDelete	VARCHAR(1000)
,@ResourceView	VARCHAR(1000)
,@ResourceEdit	VARCHAR(1000)
,@ResourceID VARCHAR(1000)
,@userName varchar(50)
,@BranchName VARCHAR(50)

)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
SET @SQLString = N'IF NOT EXISTS(SELECT ''*'' FROM '+@DBName+'.dbo.Authentication 
					WHERE EmployeeID ='''+ CONVERT(VARCHAR(10),@EmployeeName)+''' AND ACTIVE = ''TRUE'' )
	BEGIN
		INSERT INTO '+@DBName+'.dbo.Authentication
		(
			EmployeeID,
            ResourceID,
			[All] ,
			[Save],
			[Delete],
			[View],
			Edit,
			Active,
			BranchName,
			CreatedBy,
			CreatedDate
		)
		VALUES
		(
			'''+CONVERT(VARCHAR(20),@EmployeeName)+''',
            '''+@ResourceID+''',
			'''+@ResourceAll+''',
			'''+@ResourceSave+''',
			'''+@ResourceDelete+''',
			'''+@ResourceView+''',
			'''+@ResourceEdit+''',
			''True'',
			'''+@BranchName+''',
			'''+@userName+''',
			'''+@GETDATE+'''
		)
	END'

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

=================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go




ALTER PROCEDURE [dbo].[Authentication_U]
(
	@ID					INT
,	@EmployeeName		INT
,	@ResourceID	VARCHAR(1000)
,	@ResourceAll	VARCHAR(1000)
,	@ResourceSave	VARCHAR(1000)
,	@ResourceDelete	VARCHAR(1000)
,	@ResourceEdit	VARCHAR(1000)
,	@ResourceView	VARCHAR(1000)
,@userName varchar(50)
,@BranchName varchar(50)

)
AS

DECLARE @GETDATE VARCHAR(15)
SET @GETDATE =(SELECT CONVERT(VARCHAR(15),GETDATE(),101))

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
SET @SQLString = N'UPDATE ' + @DBName + '.dbo.Authentication SET
         
ResourceID = '''+CONVERT(VARCHAR(1000),@ResourceID)+''',
[All] = '''+@ResourceAll+''',
[Save] = '''+@ResourceSave+''',
[Delete] = '''+@ResourceDelete+''',
[View] = '''+@ResourceView+''',
Edit = '''+@ResourceEdit+''',
BranchName='''+@BranchName+''',
UpdatedBy = '''+@userName+''',
UpdatedDate = '''+@Getdate+'''
WHERE EmployeeID = '''+CONVERT(VARCHAR(10),@EmployeeName)+''' AND BranchName='''+@BranchName+''' and active = ''True'''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END

==========================================================================================================================================

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go



ALTER PROCEDURE [dbo].[Authent_S]
(
@User varchar(25)
,@BranchName VARCHAR(50)
)
AS

DECLARE @DBName NVARCHAR(2550)

SELECT @DBName=(SELECT NAME
FROM sys.databases WHERE NAME=@BranchName)

DECLARE @UseAndExecStatment NVARCHAR(4000), @SQLString NVARCHAR(4000)

SET @UseAndExecStatment = 'USE ' + @DBName +' EXEC sp_executesql @SQLString'

BEGIN
	SET @SQLString = N'SELECT (ResourceID) as ResourceID,
([All]) as All1 ,
([Save]) as Save1 ,
([Delete]) as Delete1 ,
([View]) as View1 ,
(Edit) as Edit 
 

FROM ' + @DBName + '.dbo.Authentication WHERE EmployeeID='''+@User+''' AND Active=''True'''

EXEC sp_executesql @UseAndExecStatment, N'@SQLString nvarchar(4000)', @SQLString=@SQLString

END





